::Title::Star Wars Dark Forces 2 and Mysteries of the Sith
::
{h1 Fixes and improvements} 
{f Easy installation on 64 bit systems, details bellow }
{f Fixes black screen when 3D acceleration is enabled}
{f Fixes a ghosting bug when 3D acceleration is enabled} 
{f Fixes music playback}
{f [gototab_...graphics_HD Forced resolution] prevents display modes changes on
menu access}
{i [gototab_...graphics_HD Forced resolution] allows hight resolution 
without shrinking the HUD\menus and [gototab_...graphics_SSAA super 
sampling anti aliasing]}
{i Automatic FOV correction in any aspect ratio }
{i  Disables the "manual" mipmapping employed by the game that makes distant 
textures blurry - Adapted from a|mips ^ here|a} 
{i %Textures% }
{i %Xinput% }

{b {nfo} ==[Supported versions]==
<ul>
  <li>b|GOG|b with [patch this patch*]|n 
  For this version, check if the installer included a i|ddraw.dll|i file in
  the game's directoy and delete that file
  <li>For the b| CD version|b download [old_version_redirect version 0.10.11] of
  peixoto's patch</li>    
</ul> ||n    

You also should never rename the -[.exe]- files, because the program checks 
the name of the target 
-[.exe]- file to determine which fixes to apply 

>>n*It's possible that this executable might break disk swap on GOG's MCI
emulator, but peixoto's patch fails to hook DirectDraw\Direct3D with the 
executable shiped with GOG's version. I'll fix that in the future       
}  

{b {f} ==[FOV glitch]==
In Mysteries of the sith, loading a save created while using the stormtrooper 
rifle scope can cause a FOV glitch, but the right FOV can be reset just entering
and leaving the menu. Saves created with the patch can also have the wrong FOV 
when played without the patch }
    

::Section::Settings::
::BOOL::Zblit::Use z blits::Uncheck this if the zbuffer is not cleared correctly:: 
::%ddraw%::

::link::mips->http://shinyquagsire23.github.io/dk2-mots/
::link::patch->https://community.pcgamingwiki.com/files/file/986-jedi-knight-df2-mots-pre-patched-unofficial-patches/

::link::INSTALL_SCRIPT->#persistent
if (A_OsVersion = "WinXP")
{
   msgbox, 16, ,Can only install on vista and latter
   exitapp  
}
select := TaskDialogPageHandler.new(True, "Installer|Which game to install ?||||||", "Dark Forces 2|Misteries of the Sith|Cancel")
if (choice := TaskDialogPageHandler.show()) = 1001
	JK()
else if choice = 1002
	JKM()
exitapp

JK()
{
	DriveGet, drives, list, CDROM
	JK=
	for k, v in strsplit(drives)
		fileexist(v ":\GAMEDATA\EXE\JK.EXE") ? JK := v
	if not JK
	{
		msgbox, 16, ,Please insert Disk 1
		exitapp   
	} 

	if not (dest := ui_GetDestinationFolder("Games\Star Wars\Jedi Knight - Dark Forces 2",,,False))
		exitapp
	
	filecreatedir, %dest%\CONTROLS 
	filecreatedir, %dest%\EPISODE 
	filecreatedir, %dest%\RESOURCE 
	filecreatedir, %dest%\EXTRAS 
	ShellUnzip(JK ":\GAMEDATA\EXE", dest)  
	ShellUnzip(JK ":\GAMEDATA\CONTROLS", dest "\CONTROLS") 
	ShellUnzip(JK ":\GAMEDATA\EPISODE", dest "\EPISODE") 
	ShellUnzip(JK ":\GAMEDATA\RESOURCE", dest "\RESOURCE")
	ShellUnzip(JK ":\GAMEDATA\MININSTALL", dest "\RESOURCE")
 
 if fileexist(JK ":\GAMEDATA\RESOURCE\VIDEO\23A.smk")
 {
      ;ShellUnzip(JK ":\Disk2\GAMEDATA\RESOURCE\VIDEO", dest "\RESOURCE\VIDEO")
      goto finish
 }

	while ! fileexist(JK ":\GAMEDATA\RESOURCE\VIDEO\23A.smk")
	{
		msgbox, 49 ,Installer ,Insert Disk 2 on drive %JK%
		IfMsgBox, Cancel
			ExitApp
	}
	
	ShellUnzip(JK ":\GAMEDATA\RESOURCE\VIDEO", dest "\RESOURCE\VIDEO")
	finish:
	subkey=SOFTWARE\LucasArts Entertainment Company LLC\JediKnight\v1.0 

    /*
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, Source Path, %JK%:\\
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, CD Path, %JK%:\\
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, Source Dir, %JK%:\\
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, Sound File, %JK%:\RESOURCE\RES1HI.GOB
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, JoystickID, 1
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, bLowRes, TRUE
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, Executable, %dest%\JK.exe
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, Install Path, %dest%
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, Analyze Path, %TPM%:\\INSTALL\\SysCheck.exe
	RegWrite, REG_DWORD, HKEY_LOCAL_MACHINE, %SubKey%, InstallType, 00000001 
    */
	msgbox, 64,, Done, you will need to have your CD on drive %JK% whenever you want to play! 
	exitapp  
}
	
JKM()
{	
	DriveGet, drives, list, CDROM
	JK=
	for k, v in strsplit(drives)
		fileexist(v ":\GAMEDATA\EXE\JKM.EXE") ? JK := v
	if not JK
	{
		msgbox, 16, ,Please insert the game's CD ROM
		exitapp   
	} 

	if not (dest := ui_GetDestinationFolder("Games\Star Wars\Jedi Knight - Mysteries of the Sith",,,False))
		exitapp
	
	filecreatedir, %dest%\CONTROLS 
	filecreatedir, %dest%\EPISODE 
	filecreatedir, %dest%\RESOURCE 
	filecreatedir, %dest%\EXTRAS 
	ShellUnzip(JK ":\GAMEDATA\EXE", dest)  
	ShellUnzip(JK ":\GAMEDATA\CONTROLS", dest "\CONTROLS") 
	ShellUnzip(JK ":\GAMEDATA\EPISODE", dest "\EPISODE") 
	ShellUnzip(JK ":\GAMEDATA\RESOURCE", dest "\RESOURCE")
	ShellUnzip(JK ":\GAMEDATA\MININSTALL", dest "\RESOURCE")	
	subkey=SOFTWARE\LucasArts Entertainment Company LLC\Mysteries of the Sith\v1.0
    RegDelete, HKEY_LOCAL_MACHINE, %SubKey% 
	/*
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, Source Path, %JK%:\\
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, CD Path, %JK%:\\
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, Source Dir, %JK%:\\
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, Sound File, %JK%:\RESOURCE\JKMSNDLO.GOO
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, JoystickID, 1
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, bLowRes, TRUE
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, Executable, %dest%\JKM.exe
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, Install Path, %dest%
	RegWrite, REG_SZ, HKEY_LOCAL_MACHINE, %SubKey%, Analyze Path, %TPM%:\\INSTALL\\SysCheck.exe
	RegWrite, REG_DWORD, HKEY_LOCAL_MACHINE, %SubKey%, InstallType, 00000001 
    */
	msgbox, 64,, Done, you will need to have your CD on drive %JK% whenever you want to play! 
	exitapp  
}
	


