<script>
	var g_ = { Game: "" }

	async function LaunchGame(game) {
		fetch('/LaunchGame?Game=' + game, FetchOPtions());
	}

	async function CreateShortCut(game) {
		fetch('/CreateShortCut?Game=' + game, FetchOPtions());
	}

	async function IniGet(game, key, section) {
		return (await (await fetch('/GetVal?Game=' + game + '&Key=' + key + '&Section=' + section, FetchOPtions())).text()).toLowerCase();
	}

	async function IniGetJ2k(game, key, section) {
		let val = (await IniGet(game, key, section)).replaceAll("gamepad", "Gamepad").split(",")
		while (val.length < 20) {
			val.push("")
		}
		return val
	}

	function IniSet(game, key, val, section) {
		fetch('/SetVal?Game=' + game + '&Key=' + key + '&Val=' + val + '&Section=' + section, FetchOPtions());
	}

	async function IniIsTrue(game, key, section) {
		reply = await (await fetch('/IsTrue?Game=' + game + '&Key=' + key + '&Section=' + section, FetchOPtions())).text();
		return reply === 'true' ? true : false;
	}

	async function LaunchCE(game) {
		fetch('/LaunchCE?IniFileName=' + game, FetchOPtions());
	}

	// JavaScript implementation of the AutoHotkey ParseText function
	async function ParseTextImp(txt) {
		const _MCI = `To get the CD music working properly, check the a|gototab_sound_WNMM.MCI ^ MCI emulation |a option on the a|gototab_sound_WNMM.MCI ^ sound tab |a`;

		const autodmp = `{b <b>Dumping textures</b>  <br> <br>	

  Manual dumps are impratical for dumping several textures for obvios reazons, plus the fact that there is no check 
  if a texture was already dumped and so one can be dumped many times over <br>	
  Auto dumping in the other hand, never dumps the same texture twice, but for other reazons is still impratical 
  in several games <br>	
  In future versions, a feature to dump all currently loaded texures with a check for duplicates will be added to 
  complement the two curent options}`.replace(/\n/g, '');

		// Case insensitive replacements
		const caseInsensitiveReplace = (text, search, replacement) => {
			const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
			const regex = new RegExp(escapeRegExp(search), 'gi');
			return text.replace(regex, replacement);
		};

		// Handle common replacements		
		txt = txt.replace(/\%smallres\%/g, '960 x 540');
		txt = txt.replace(/\%_MCI\%/g, _MCI);
		txt = txt.replace(/\%Xinput\%/gi, " Better compatibility with Xinput gamepads, see a|gototab_input_j2k.u ^ this|a");
		txt = txt.replace(/\%EAX\%/g, " Restores 3D audio and EAX, see a|gototab_sound_Dsnd.e ^ this|a");
		txt = txt.replace(/\r/g, "");
		txt = txt.replace(/\n/g, " ");
		txt = txt.replace(/\\/g, "&#92;");
		txt = txt.replace(/\|\|n/g, "<br><br>");
		txt = txt.replace(/\|n/g, "<br>");
		txt = txt.replace(/i\|/g, "<i>");
		txt = txt.replace(/\|i/g, "</i>");
		txt = txt.replace(/b\|/g, "<b>");
		txt = txt.replace(/\|b/g, "</b>");
		txt = txt.replace(/>>n/g, "<br><br>");
		txt = txt.replace(/>n/g, "<br>");
		txt = txt.replace(/>cc/g, "</b></font>");
		txt = txt.replace(/>c/g, "</font>");
		txt = txt.replace(/a\|/g, "<a id='");
		txt = txt.replace(/ \^ /g, "' href='javascript:dummy()' onclick='PostActionB(this)'>");
		txt = txt.replace(/\|a/g, "</a>");
		txt = txt.replace(/l\|/g, "<li>");
		txt = txt.replace(/<ul>/g, "<ul style='margin-top:0px;margin-bottom:0px;'>");
		txt = txt.replace(/<td>/g, "<td style='vertical-align: top; padding-right: 20px'>");

		// RegEx replacements (simulating AutoHotkey's case insensitivity)
		txt = txt.replace(/i<([^>.]*)>i/gi, "<i>$1</i>");
		txt = txt.replace(/b<([^>.]*)>b/gi, "<b>$1</b>");
		txt = txt.replace(/t<([^>.]*)>t/gi, "<table>$1</table>");
		txt = txt.replace(/a<([^>.]*)--([^>.]*)>a/gi, "<a id='$1' href='javascript:dummy()' onclick='PostActionB(this)'>$2</a>");

		// Replace quotes
		txt = txt.replace(/"/g, "'");

		// Handle specific replacements
		txt = txt.replace(/\%ModsLink\%/gi, "<a onclick='PostActionB(this)' id='gototab_File System_modstuto' href='javascript:dummy()'>Mods manager</a>");
		txt = txt.replace(/\%TexturesB\%/gi, "<a onclick='PostActionB(this)' id='gototab_graphics..._Textswap.e' href='javascript:dummy()'>Texture swapping</a>");
		txt = txt.replace(/\%Textures\%/gi, "<a onclick='PostActionB(this)' id='gototab_graphics..._Textswap.e' href='javascript:dummy()'>Texture swapping</a>");
		txt = txt.replace(/\%TexturesC\%/gi, "<a onclick='PostActionB(this)' id='gototab_graphics_Textswap.e' href='javascript:dummy()'>Texture swapping</a>");

		// Handle folder path replacements
		// Note: JavaScript doesn't have direct access to Windows folder paths
		// These would need to be provided from elsewhere

		txt = txt.replace(/\\/g, "\\\\");
		txt = txt.replace(/\%autodmp\%/gi, autodmp);

		// Icon replacements
		txt = txt.replace(/\{f\}/gi, "<img width='20px'; height='20px'; src='fix.svg';></img>");
		txt = txt.replace(/\{nfo\}/gi, "<img width='20px'; height='20px'; src='nfo.svg';></img>");
		txt = txt.replace(/\{i\}/gi, "<img width='20px'; height='20px'; src='star.svg';></img>");
		txt = txt.replace(/\{bad\}/gi, "<img width='20px'; height='20px'; src='bad.svg';></img>");

		// Section headings and formatting
		txt = txt.replace(/==\[([^=]*)\]==/gi, "<div class='center'><b>$1</b></div><br><br>");
		txt = txt.replace(/=\[([^=]*)\]=/gi, "<b>$1</b>");
		txt = txt.replace(/-\[([^-]*)\]-/gi, "<i>$1</i>");
		txt = txt.replace(/\[([^\]\s]+)\s+([^\]]+)\]/gi, "<a id='$1' href='javascript:dummy()' onclick='PostActionB(this)'>$2</a>");

		// Complex HTML fragments
		const fix = /*html*/ `
		<div style='display:flex;margin-left:40px'>
			<div style="color:transparent;text-shadow:0 0 0 darkblue;font-size:24px;font-weight:normal;margin-top:-8px;margin-right:4px">üõ†Ô∏è</div>
			<div>$1</div>
		</div>`;

		const imp = /*html*/`
		<div style='display:flex;margin-left:40px'>
			<div style="color:transparent;text-shadow:0 0 0 #1ab288;font-size:24px;margin-top:-8px;margin-right:4px">&#x1F44D</div>
			<div>$1</div>
		</div>`;

		const nfo = /*html*/ `
		<div style='display:flex;margin-left:40px'>
			<div style="font-size:24px;margin-top:-8px;margin-right:4px"><i class="fa-solid fa-info"></i></div>
			<div>$1</div>
		</div>`;

		const bad = /*html*/`
		<div style='display:flex;margin-left:40px'>
			<div style="color:transparent;text-shadow:0 0 0 #b00111;font-size:24px;margin-top:-4px;margin-right:4px">&#x1F44E</div>
			<div>$1</div>
		</div>`;

		const ce = /*html*/
		`<dd><div class='fix-master'>
			<div class='ce-icon'></div>
			<div class='fix-text'>$1</div>
		</div></dd>`;

		const linux = /*html*/`
		<div style='display:flex;'>
			<div style='margin-right:2px'><img src='linux.svg' width='18px' height='18px'></img></div>
			<div>$1</div>
		</div>`;

		const win = /*html*/`
		<div style='display:flex;'>
			<div style='margin-right:2px'><img src='windows.svg' width='18px' height='18px'></img></div>
			<div>$1</div>
		</div>`;

		// Apply special content replacements
		txt = txt.replace(/\{lnx\s([^}]*)\}/gi, (match, p1) => linux.replace(/\n/g, '').replace('$1', p1));
		txt = txt.replace(/\{win\s([^}]*)\}/gi, (match, p1) => win.replace(/\n/g, '').replace('$1', p1));
		txt = txt.replace(/\{f\s([^}]*)\}/gi, (match, p1) => fix.replace(/\n/g, '').replace('$1', p1));
		txt = txt.replace(/\{i\s([^}]*)\}/gi, (match, p1) => imp.replace(/\n/g, '').replace('$1', p1));
		txt = txt.replace(/\{nfo\s([^}]*)\}/gi, (match, p1) => nfo.replace(/\n/g, '').replace('$1', p1));
		txt = txt.replace(/\{bad\s([^}]*)\}/gi, (match, p1) => bad.replace(/\n/g, '').replace('$1', p1));
		txt = txt.replace(/\{ce\s([^}]*)\}/gi, (match, p1) => ce.replace(/\n/g, '').replace('$1', p1));

		// Additional HTML templating
		const fix2 = /*html*/ 
		`<div class='fix-master'>
			<div class='fix-icon'></div>
			<div class='fix-text'>$1</div>
		</div>`;

		const imp2 = /*html*/`
		<div class='fix-master'>
			<div class='improve-icon'></div>
			<div class='fix-text'>$1</div>
		</div>`;

		const nfo2 = /*html*/`
		<div class='fix-master'>
			<div class='nfo-icon'></div>
			<div class='fix-text'>$1</div>
		</div>`;

		const WARN = /*html*/
		`<div class='warning'>
			<div>$1</div>
		</div>`;

		// Apply additional formatting
		txt = txt.replace(/\{F\s([^}]*)\}/gi, (match, p1) => fix2.replace(/\n/g, '').replace('$1', p1));
		txt = txt.replace(/\{I\s([^}]*)\}/gi, (match, p1) => imp2.replace(/\n/g, '').replace('$1', p1));
		txt = txt.replace(/\{NFO\s([^}]*)\}/gi, (match, p1) => nfo2.replace(/\n/g, '').replace('$1', p1));
		txt = txt.replace(/\{ce\s([^}]*)\}/gi, (match, p1) => ce.replace(/\n/g, '').replace('$1', p1));
		txt = txt.replace(/\{WARN\s([^}]*)\}/gi, (match, p1) => WARN.replace(/\n/g, '').replace('$1', p1));
		txt = txt.replace(/\{h1\s([^}]*)\}/gi, "<div class='features'>$1</div>");
		txt = txt.replace(/\{b\s([^}]*)\}/gi, "<div class='box'>$1</div>");

		return txt;
	}

	async function ParseText(text) {
		return ParseTextImp(text);
		// Fails frequenlly on edge	
		try {
			let options = FetchOPtions();
			options.headers = { 'Content-Type': 'text/plain' };
			options.body = text;
			reply = await (await fetch('/ParseText', options)).text();
			console.log(reply)
			return reply;
		} catch (e) {
			return ParseText(text)
		}
	}

	function SetResLimitWidgetLabel(_id, game) {
		let [key, section] = _id.includes(".") ? _id.split(".") : [_id, ''];
		IniSet(game, key, document.getElementById(_id).value, section);
		let slider = document.getElementById(_id);
		let label = document.getElementById(_id + "_label");
		label.innerHTML = ["No limit", "640x480", "800x600", "1024x768", "960x540", "1280x720", "1366x768", "1600x900"
			, "1920x1080", "2560x1440", "3840x2160"][slider.value];
	}

	function SetFloatSliderLabelValue(_id, game) {
		let [key, section] = _id.includes(".") ? _id.split(".") : [_id, ''];
		IniSet(game, key, document.getElementById(_id).value, section);
		let slider = document.getElementById(_id);
		let label = document.getElementById(_id + "_label");
		label.innerHTML = slider.value;
	}

	async function AppendLink(link) {
		try {
			let lnk = link.split("->");
			console.log(lnk);
			options = FetchOPtions();
			options.body = lnk[1];
			fetch('/AppendLink?Name=' + lnk[0] + '&Url=' + lnk[1], options);
		} catch (error) {
			console.log(error);
		}
	}

	function GetDisabled(parent, radio_name) {
		if (parent === null) return false;
		if (false === parent.hasAttribute("id")) return false;
		if (false === parent.id.endsWith("_details")) return false;
		let input = document.getElementById(parent.id.replace("_details", ""));
		if (input === null) return false;
		//console.log(input.tagName.toLowerCase(), input.id);
		if (input.tagName.toLowerCase() === "label" && input.hasAttribute("id")) {
			try {
				let value = document.querySelector(`input[name="${input.id}"]:checked`).value;
				console.log(input.id, "=", value);
				return value === '0' ? true : false;
			} catch (error) {
				return false;
			}
		}
		if (false === input.tagName.toLowerCase() == "input" ||
			false === input.hasAttribute("type")) return false;
		if (input.type.toLowerCase() === "checkbox") return input.checked ? false : true;
	}

	function SelectTab(tab) {
		for (let child of document.getElementById("tabs-divs").children) {
			child.style.display = "none";
			child.classList = "tab-pane fade";
		}
		document.getElementById(tab.id.replace("-tab", "_div")).classList = "tab-pane fade show active";
		document.getElementById(tab.id.replace("-tab", "_div")).style.display = "flex";
	}

	function SetThreeState(element, state, game) {
		if (element.tagName.toLowerCase() === "input" && element.hasAttribute("type")) {
			//element.disabled = state === true ? false : true;
			if (element.type.toLowerCase() === "checkbox") {
				let parent = document.getElementById(element.dataset.parent);
				if (parent != null) {
					element.disabled = GetDisabled(parent);
					if (element.disabled === true) {
						element.checked = false;
						let [key, section] = element.id.includes(".") ? element.id.split(".") : [element.id, ''];
						IniSet(game, key, element.checked ? "true" : "false", section);
					}
				}
			}
			else if (element.type.toLowerCase() === "radio") {
				let parent = document.getElementById(element.dataset.parent);
				//console.log(parent.id);
				if (parent != null) {
					element.disabled = GetDisabled(parent, element.name);
					//console.log(element.disabled, element.value);
					if (element.disabled === true) {
						element.checked = element.value === '0' ? true : false;
						if (element.value === '0') {
							let [key, section] = element.name.includes(".") ? element.name.split(".") : [element.name, ''];
							IniSet(game, key, element.value, section);
						}
					}
				}
			}
		}
		for (let child of element.children) {
			SetThreeState(child, state, game);
		}
	}

	function CheckboxChanged(game, _this) {
		let children_container = document.getElementById(_this.id + "_details");
		SetThreeState(children_container, _this.checked, game);
		let [key, section] = _this.id.includes(".") ? _this.id.split(".") : [_this.id, ''];
		console.log(key, section, _this.checked);
		IniSet(game, key, _this.checked ? "true" : "false", section);
	}

	function RadioChanged(game, _this) {
		let children_container = document.getElementById(_this.name + "_details");
		let state = _this.value === '0' ? true : false
		SetThreeState(children_container, _this.checked);
		let [key, section] = _this.name.includes(".") ? _this.name.split(".") : [_this.name, ''];
		IniSet(game, key, _this.value, section);
	}

	async function RenderGamePage(_this) {
		g_.Game = _this.innerText;
		let GameName = _this.innerText;
		let UrlFriendlyGameName = encodeURIComponent(GameName).replaceAll(/'/g, "%27");

		document.getElementById("game-page").innerHTML = /*html*/ `
		<p class="h5" style="margin-top:10px">${GameName}</p>
		<div class="cntrl_group" style="gap:10px;overflow-y:hidden">			
			<div class="cntrl_group" style="gap:0px;overflow-y:auto;min-height:480px;padding-left:10px">
		</div>
		`
		let parent = document.getElementById("game-page").children[1].children[0];
		let help = await (await fetch('/GameHelp?Game=' + GameName, FetchOPtions())).text();
		tokens = help.split("::");
		console.log(help);

		for (let [i, token] of tokens.entries()) {
			try {
				let sec = token.toLowerCase().trim();
				if (sec === 'title') {
					let title = tokens.at(i + 1)
					title = title.toLowerCase().trim() === 'user' ? GameName : title
					let wiki = await IniGet(GameName, 'wiki', '')
					wiki = wiki === '' ? '' : /*html*/` 
					<button class="button btn btn-light" style="width:150px;border:1px solid #000066" onclick="window.open('${wiki}', '_blank')"> 
						<img style="fill:white" src="PCGamingWiki_wide.svg"><img>
					</button> `
					let table = await GetCheatTablePath(GameName)
					let ver = await IniGet(GameName, 'ver', '');
					if (ver !== '') {
						ver = /*html*/`
						<div class="alert alert-danger">
							<h3>Version warning</h3>This warning means that I don't have this game installed anymore and therefore
           					I can't test it when I make changes on parts of the program that can affect it, and that I don't offer support for it
            				<br><br>This game was last tested on version
            				<a id='old_version_redirect' href='javascript:dummy()' onclick="PostActionB(this)"> ${ver} </a>
						</div>`
					}
					table = table === '' ? '' : /*html*/` 
					<button class="button btn btn-light" style="width:120px;border:1px solid #000066" id="CE::Button"
						onclick="
						document.getElementById('CE::Div').classList = 
						document.getElementById('CE::Div').classList.toString() === 'alert alert-warning grow-vertical' ? 
						'alert alert-warning shrink-vertical' : 'alert alert-warning grow-vertical';
						console.log(document.getElementById('CE::Div').classList.toString())
						if (document.getElementById('CE::Div').classList.toString() === 'alert alert-warning srink-vertical') {
							setTimeout(()=>{
								document.getElementById('CE::Div').style.display = 'none';
							}, 500);
						} else{
							document.getElementById('CE::Div').style.display = 'flex';
						}
						"> 
						<img style="margin-top:-4px;margin-right:10px" src="Cheats_small.png"><img>Cheats
					</button>`
					let cediv = table === '' ? '' : /*html*/`
					<div id="CE::Div" class="alert alert-warning shrink-vertical" style="z-index:1;display:none;flex-direction:column;">
						<p class="h3"><b>Using cheats</b><p>
						<ul> 
							<li>Install <a id="cheat" onclick="PostActionB(this)" href="javascript:dummy()">cheat engine (64bit)</a> if you don\'t already have it
							<li> Start <a id="cheat" onclick="PostActionB(this)" href="javascript:dummy()">cheat engine (64bit)</a> using the button bellow and the appropriate table will beloaded
							<li> If you have already stated the game once with WineHooks, cheat engine will attatch itself to the game, and close itself when you exit the game                                                                                                                 	
							<li> Configure cheat engine to aways exectute lua scripts:<br>                                                                                         
							edit &#x2192 settings &#x2192 general settings &#x2192 when a table has a lua script, execute it &#x2192 <b>ALWAYS</b>                                	
							<li> All tables use an Autohotkey plugin, so if you modify or start them directly with cheat engine, they might not work properly                      
							<li> If a cheat doesn\'t work because you have a different version of the game, click table extras on cheat engine                               
							exception made for very old games, I leave comments there which sould help you adapt the table
						</ul>                                                    
						<div style="display:flex;flex-direction:row-reverse;gap:10px">
							<button class="btn btn-light" style="border: 1px solid #000066" onclick="LaunchCE('${GameName.replaceAll('\'', '%27')}')">
								<img style="height:30px" src="ce.svg">
							</button>
							<!--<button class="btn btn-danger"
								onclick="document.getElementById('CE::Div').style.display = 'none'">Close
							</button>-->
						</div>
					</div>
					`
					parent.insertAdjacentHTML('beforeend', /*html*/`
					<p class="h1">${title}</p>
					<div style="display:flex;flex-direction:row;gap:10px;margin-top:10px;margin-bottom:20px;position:relative">
						<button class="button btn btn-secondary" style="width:100px" onclick="LaunchGame('${UrlFriendlyGameName}')">	
							<i class="fa-solid fa-circle-play fa-2xl"></i>
							Play
						</button>	
						<button class="button btn btn-secondary" style="width:200px" onclick="CreateShortCut('${UrlFriendlyGameName}')">
							<i class="fa-solid fa-share fa-2xl"></i>
							Create shortcut
						</button>						
						${wiki}
						${table}						
					</div>
					${ver}
					${cediv}
					${await ParseText(tokens.at(i + 2))}
				`)
				} else if (sec === 'parent') {
					let new_parent_id = tokens.at(i + 1).toLowerCase().trim()
					if (new_parent_id.startsWith("pxswap") || new_parent_id.startsWith("textswap")) {
						parent = null;
					}
					if (document.getElementById(new_parent_id) === null) {
						continue
					}
					parent = document.getElementById(new_parent_id)
					if (parent === null) {
						console.error(`parent ${tokens.at(i + 1)} not found`)
					}
				} else if (sec === 'tab') {
					let tbs = ('üè†' + '|' + tokens.at(i + 1)).toLowerCase().trim().split("|")
					let tabs = tbs.map(t =>
						t.replace("graphics", "&#128250;")
							.replace("sound", "&#127911;")
							.replace("input", "&#128377;")
							.replace("file system", "&#128193;")
							.replace("cpu", "MISC"))
					let html = /*html*/`<ul class="nav nav-tabs" id="tabs-buttons" style="display:inline" role="tablist">`
					for (const [index, tab] of tabs.entries()) {
						let active = index === 0 ? "active" : ""
						html += /*html*/`
						<li class="nav-item" role="presentation" style="display:inline">
							<button class="nav-link ${active}" id="${tbs[index]}-tab" style="display:inline"
							data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" 
							aria-controls="profile" aria-selected="false" onclick="SelectTab(this)">${tab}</button>
						</li>
						`
					}
					html +=  /*html*/`</ul><div class="tab-content" id="tabs-divs" style="overflow-y:auto;height:100%">`
					for (const [index, tab] of tabs.entries()) {
						let active = index === 0 ? "show active" : ""
						html += /*html*/`
						<div class="tab-pane fade ${active}" id="${tbs[index]}_div" role="tabpanel" 
							style="display:flex;flex-direction:column;overflow-y:auto;padding-left:10px"
							aria-labelledby="${tbs[index]}-tab" tabindex="${index}">
						</div>`
					}
					html +=  /*html*/`</div>`
					document.getElementById("game-page").children[1].insertAdjacentHTML("beforeend", html)
					let home = document.getElementById("game-page").children[1].children[0]
					document.getElementById("game-page").children[1].removeChild(home)
					document.getElementById('üè†_div').insertAdjacentElement("beforeend", home)
				} else if (sec.endsWith("tab") && !(sec === 'inputtab')) {
					let id = sec.replace("tab", "_div")
					console.log(id)
					parent = document.getElementById(id)
					console.log(parent)
				} else if (sec === 'bool') {
					let id = tokens.at(i + 1).toLowerCase().trim()
					if (id.startsWith("pxswap") || id.startsWith("textswap") || id.startsWith("j2k"))
						continue

					let [key, section] = id.includes(".") ? id.split(".") : [id, '']
					let checked = await IniIsTrue(GameName, key, section) ? "checked" : ""
					let label = await ParseText(tokens.at(i + 2))
					let details = await ParseText(tokens.at(i + 3))
					let disabled = GetDisabled(parent) || id == '4k' ? "disabled" : ""
					parent.insertAdjacentHTML("beforeend", /*html*/`
					<div style="display:flex;flex-direction:column;gap:0px">
						<div style="display:flex;flex-direction:row;gap:10px;align-items:left">
							<input type="checkbox" id="${id}" class="form-check-input" ${checked} ${disabled} data-parent="${parent.id}"
							style="margin-top:4px" onchange="CheckboxChanged('${UrlFriendlyGameName}', this)">
							<label class="form-check-label" for="${tokens.at(i + 1).toLowerCase().trim()}">${label}</label>					
						</div>
						<label class="form-check-label" for="${tokens.at(i + 1).toLowerCase().trim()}"
							style="margin-left:26px">${details}
						</label>
						<div style="margin-left:26px;margin-top:0px; display:flex;flex-direction:column;gap:0px" id="${id}_details"></div>
					</div>`)
				} else if (sec === 'radiohead') {
					let id = tokens.at(i + 1).toLowerCase().trim()
					let label = await ParseText(tokens.at(i + 2))
					let html = /*html*/`
					<div style='display:flex;flex-direction:column;'>
						<label id="${id}" class="form-check-label">${label}</label>                                                         
						<div id="${id}_details" style='margin-left:26px;display:flex;flex-direction:column' data-parent="${parent.id}"></div>
					</div>`;
					console.log('=======================================rhead=====================================', id)
					parent.insertAdjacentHTML("beforeend", html)
				} else if (sec === 'radio') {
					let [name, value] = tokens.at(i + 1).toLowerCase().trim().split("=")
					if (value === 'false') value = '0';
					let [key, section] = name.includes(".") ? name.split(".") : [name, '']
					let curr_value = await IniGet(GameName, key, section)
					if (curr_value === 'false' || curr_value === '') curr_value = '0'
					let checked = curr_value === value ? "checked" : ""
					let parent_id = parent.dataset.parent
					let disabled = GetDisabled(document.getElementById(parent_id)) ? "disabled" : ""
					console.log(name, value, curr_value, checked)
					parent.insertAdjacentHTML("beforeend", /*html*/`
					<div style="display:flex;flex-direction:row;gap:10px;align-items:left;margin-left:-26px">
						<input type="radio" name="${name}" value="${value}" id="${name}=${value}" class="form-check-input" 
						style="margin-top:4px" ${checked} ${disabled} data-parent="${parent_id}" onchange="RadioChanged('${UrlFriendlyGameName}', this)">
						<label class="form-check-label" for="${name}=${value}">${tokens.at(i + 3)}</label>					
					</div>`)
				} else if (sec === "link") {
					AppendLink(tokens.at(i + 1))
				} else if (sec === "text") {
					parent.insertAdjacentHTML("beforeend", await ParseText(tokens.at(i + 1)))
				} else if (sec === "_rlmt_") {
					let _id = tokens.at(i + 1).toLowerCase().trim()
					let head = tokens.at(i + 2)
					let index = parseInt(await IniGet(GameName, 'rlmt', ''))
					let val = ["No limit", "640x480", "800x600", "1024x768", "960x540", "1280x720", "1366x768", "1600x900"
						, "1920x1080", "2560x1440", "3840x2160"][index];
					let html = /*html*/`
					<label style='margin-left:7px;margin-bottom:0px'>&bull; &ensp;${head}</label>
						<div style='display:flex;flex-direction:row;margin-left:26px;margin-bottom:0px;margin-top:0px'>
							<input class='slider' onchange='SetResLimitWidgetLabel("${_id}", "${UrlFriendlyGameName}")' 
								type='range' min='0' max='10' step='1' id='${_id}' value='${index}'>
							<label style='margin-left:6px;margin-top:0px' id='${_id}_label'>${val}</label>                     
						</div>
					<div style='margin-left:24px;margin-top:0px'></div>`
					parent.insertAdjacentHTML("beforeend", html)
				} else if (sec === "float") {
					let [min, max, step] = tokens.at(i + 3).split("-")
					let details = await ParseText(tokens.at(i + 4))
					let _id = tokens.at(i + 1).toLowerCase().trim()
					let head = tokens.at(i + 2)
					let value = await IniGet(GameName, _id, '')

					let html = /*html*/`
					<div style='display:flex;flex-direction:column;'>
						<label style='margin-top:2px;'>${head}</label>
						<div style='display:flex;margin-left:20px;margin-top:0px'>
							<input class='slider' 
									onchange='SetFloatSliderLabelValue("${_id}", "${UrlFriendlyGameName}")' 
									type='range' 
									min='${min}' 
									max='${max}' 
									value='${value}' 
									step='${step}' 
									id='${_id}'>
							<label style='margin-left:6px;margin-top:0px' id='${_id}_label'>${value}</label>
						</div>
						<div style='display:flex;flex-direction:column;margin-top:0px;margin-left:19px' id='${_id}_details'>${details}</div>
					</div>`
					parent.insertAdjacentHTML("beforeend", html)
				} else if (sec === "hidden") {
					let hint_id = tokens.at(i + 1).toLowerCase().trim()
					let label = await ParseText(tokens.at(i + 2))
					let hint = (await ParseText(tokens.at(i + 3))).replaceAll("<br>", "")
					if (parent === null) continue;

					let html = /*html*/`
					<button class="btn btn-primary" 
						data-bs-toggle="collapse" data-bs-target="#${hint_id}_colapse" 
						aria-expanded="false" aria-controls="collapseExample" 				
						style="display:flex;flex-direction:row;margin-left:0px;gap:2px;width:max-content; padding-bottom:0px;padding-top:0px;
						padding-left:4px;padding-right:8px;margin-bottom:2px">
						<div style="width:40px;rotate:180deg;cursor:pointer;margin-left:0px;margin-top:2px">
							üí¨ 
						</div>
						${label}
					</button>
					<div class="collapse" id="${hint_id}_colapse">
						<div class="card card-body">
							${hint}
						</div>
					</div>
					`
					parent.insertAdjacentHTML("beforeend", html)
				} else if (sec === "endofsettings") {
					let id = "hdpi"
					let [key, section] = id.includes(".") ? id.split(".") : [id, '']
					let checked = await IniIsTrue(GameName, key, section) ? "checked" : ""
					let label = "Hight DPI aware"
					let details = ""
					let disabled = GetDisabled(parent) || id == '4k' ? "disabled" : ""
					parent.insertAdjacentHTML("beforeend", /*html*/`
						<div style="display:flex;flex-direction:column;gap:0px">
							<div style="display:flex;flex-direction:row;gap:10px;align-items:left">
								<input type="checkbox" id="${id}" class="form-check-input" ${checked} ${disabled} data-parent="${parent.id}"
								style="margin-top:4px" onchange="CheckboxChanged('${GameName}', this)">
								<label class="form-check-label" for="${tokens.at(i + 1).toLowerCase().trim()}">${label}</label>					
							</div>
							<label class="form-check-label" for="${tokens.at(i + 1).toLowerCase().trim()}"
								style="margin-left:26px">On windows, enables the hight dpi aware shim
							</label>
							<div style="margin-left:26px;margin-top:0px; display:flex;flex-direction:column;gap:0px" id="${id}_details"></div>
						</div>`)

					let curr_value = await IniGet(GameName, 'compatlayer', '')
					console.log(curr_value)

					let html = /*html*/`
					<div style='display:flex;flex-direction:column;margin-top:0px;margin-left:0px'>
						<label style='margin-top:10px;width:max-content;margin-right:10px'>Windows compatibility modes</label>
						<select class="form-select" id="compatlayer" 
							style="width:max-content;margin-top:6px">
							<option value="don't change">Don't Change</option>
							<option value="none">None</option>
							<option value="dwm8and16bitmitigation">DWM8And16BitMitigation</option>
							<option value="layer_win95versionlie">Layer_Win95VersionLie</option>
							<option value="win95">Win95</option>
							<option value="win98">Win98</option>
							<option value="faulttolerantheap">FaultTolerantHeap</option>
							<option value="win2000">Win2000</option>
							<option value="win2000sp2">Win2000Sp2</option>
							<option value="win2000sp3">Win2000Sp3</option>
							<option value="winxp">WinXP</option>
							<option value="winxpsp2">WinXPSp2</option>
							<option value="winxpsp3">WinXPSp3</option>
							<option value="vistasp2">VistaSp2</option>
						</select>
					</div>
					`
					parent.insertAdjacentHTML("beforeend", html)
					$('.dropdown-toggle').dropdown()
					if (curr_value === "#") curr_value = "don\'t change"
					else if (curr_value === '') curr_value = 'none'
					document.getElementById("compatlayer").value = curr_value;
					document.getElementById("compatlayer").onchange = function () {
						let val = this.value;
						if (val === "don't change") val = "#"
						else if (val === "none") val = ""
						IniSet(GameName, 'compatlayer', val, '')
					}
				} else if (sec === "%_textswap_%") {
					let prnt = document.getElementById("graphics..._div")
					if (prnt === null) prnt = document.getElementById("graphics_div")
					if (prnt === null) prnt = document.getElementById("üè†_div")
					if (prnt === null) prnt = prnt = document.getElementById("game-page").children[1].children[0];
					prnt.insertAdjacentHTML("beforeend", /*html*/`
						<div style="display:flex;flex-direction:row;gap:20px" id="tswap-button-container">
							<button class="btn btn-primary" style="width:max-content;margin-top:20px" onclick="ShowTextSwapDialog('${UrlFriendlyGameName}')">
								<div style="display:flex;flex-direction:row;gap:10px">
									<i class="fa-solid fa-wrench fa-2xl" style="margin-top:20px"></i>
									<div style="border-right:1px solid white; width:1px"></div>
									<div style="display:flex;flex-direction:column;gap:0px">
										<p style="font-weight:bold;margin-bottom:0px; text-align:left;">Texture Swap</p>
										<p style="margin-top:0px;margin-bottom:0px;text-align:left;font-weight:lighter">Enable, disable or configure texture swap</p>
									</div>
								</div>	
							</button>
						</div>
					`)
				} else if (sec === "%_pixelswap_%") {
					let prnt = document.getElementById("tswap-button-container")
					prnt.insertAdjacentHTML("beforeend", /*html*/`
						<button class="btn btn-primary" style="width:max-content;margin-top:20px" onclick="ShowPxSwapDialog('${UrlFriendlyGameName}')">
							<div style="display:flex;flex-direction:row;gap:10px">
								<i class="fa-solid fa-wrench fa-2xl" style="margin-top:20px"></i>
								<div style="border-right:1px solid white; width:1px"></div>
								<div style="display:flex;flex-direction:column;gap:0px">
									<p style="font-weight:bold;margin-bottom:0px; text-align:left;">Pixel shader Swap</p>
									<p style="margin-top:0px;margin-bottom:0px;text-align:left;font-weight:lighter">Enable, disable or configure pixel shader swap</p>
								</div>
							</div>	
						</button>						
					`)
				} else if (sec === "inputtab") {
					let Key_A = await IniGetJ2k(GameName, 'a', 'j2k')
					let Key_B = await IniGetJ2k(GameName, 'b', 'j2k')
					let Alt_A = await IniGetJ2k(GameName, 'x', 'j2k')
					let Alt_B = await IniGetJ2k(GameName, 'y', 'j2k')
					let Modes = await IniGetJ2k(GameName, 'mds', 'j2k')
					let cfg = {
						'Key_A': Key_A,
						'Key_B': Key_B,
						'Alt_A': Alt_A,
						'Alt_B': Alt_B,
						'Modes': Modes,
						'm': isNaN(parseInt(await IniGet(GameName, "m", "j2k"))) ? "0" : await IniGet(GameName, "m", "j2k"),
						'rs': isNaN(parseInt(await IniGet(GameName, "rs", "j2k"))) ? "0" : await IniGet(GameName, "rs", "j2k"),
						'spd': isNaN(parseFloat(await IniGet(GameName, "spd", "j2k"))) ? "0.2" : await IniGet(GameName, "spd", "j2k"),
						'dz': isNaN(parseFloat(await IniGet(GameName, "dz", "j2k"))) ? "0.15" : await IniGet(GameName, "dz", "j2k"),
						'rs_alt': await IniIsTrue(GameName, 'rs_alt', 'j2k'),
						'FF': await IniIsTrue(GameName, 'FF', 'j2k'),
						'u': await IniIsTrue(GameName, 'u', 'j2k')
					}
					console.log(cfg)
					let deadzone = cfg.dz * 100
					let speed = cfg.spd * 100
					parent = document.getElementById(sec.replace("tab", "_div"))
					let checked = await IniIsTrue(GameName, 'u', 'j2k') ? "checked" : ""
					parent.insertAdjacentHTML("beforeend", /*html*/`
						<div style="display:flex;flex-direction:column;gap:0px;position:relative"  class="alert alert-secondary">
							<div style="display:flex;flex-direction:row;gap:10px;align-items:left">
								<input type="checkbox" id="j2k.u" class="form-check-input" ${checked}
									style="margin-top:4px" 
									onchange="
									let cfg = GetDinputCfg();
									cfg.u = this.checked;
									cfg.update();
									SetTableThreeState(document.getElementById('j2kroot'),  this.checked)">
								<label class="form-check-label" for="${"dinput.e".toLowerCase().trim()}">
									Enable Xinput to DirectInput translation
								</label>									
							</div>		
							<label style="margin-left:26px;margin-bottom:20px">
								Input from a <a href="javascript:dummy()" id="dinput" onclick="PostActionB(this)">XInput gamepad</a>
								is translated to <a href="javascript:dummy()" id="dinput" onclick="PostActionB(this)">DirectInput</a>,
								keyboard or mouse input		
							</label>
							<div style="display:none;flex-direction:column;gap:4px;position:absolute;z-index:2" id="dinput-help-div"
								class="alert alert-warning" id="dinput-help" style="width:100%;height:max-content;text-align:justify">	
								<h5 class="h5">Buttons</h5>			
								<ul>
									<li><b>DirectInput Gamepad mode:</b> the button emulates the gamepad button configured in the <b>Key A</b> column</li>
									<li><b>Keyboard mode:</b> the button emulates the keyboard keys or mouse buttons configured in the <i><b>Key A</b></i> and
										<i><b>Key B</b></i> (if any) columns or, if the 
										<div class="text-bg-danger" 
											style="width:max-content;border-radius:10px;height:34px;padding:4px 4px 0px 4px;display:inline-block">
											Modifier
										</div> 
									button is pressed, the keys configured in the  
									<i><b>Alt A</b></i> and <i><b>Alt B</b></i> columns</li>
									<li><b>Keyboard repeat:</b> while held down, the button continuously generates input events from the keyboard key or mouse button configured in the  
									<i><b>Key A</b></i> column. Key combinations or alternative keys are not supported in this mode and neither is the mouse wheel 
									<li><b>Keyboard toggle:</b> when the button is pressed, a <i><b>keydown</b></i> event from the
									<i><b>Key A</b></i> key is generated and a when the button is pressed again, a <i><b>keyup</b></i> event will be sent.
									Mouse input is not supported in this mode and neither are key combinations or alternative keys
									<li><b>Keyboard tap:</b> Simnilar to <b>Keyboard</b>, but pressing the button generates a single tap of the correspoding key, even if the
									button is held down<br></li>\
									<li><b>NOTE:</b> there will be some games on which <b>Keyboard</b> behaves as <b>Keyboard repeat</b> and <b>Keyboard tap</b> behaves as <b>Keyboard</b>
								</ul>
								<h5 class="h5">Dpad</h5>		
								<ul>
									<li><b>Default:</b> The dpad behaves as it normally does and whatever is set on the <b>Up\\Down\\Left\\Right</b> columns is ignored</li>
									<li><b>Keyboard:</b> The dpad emulates four keyboard keys or mouse buttons configured on the <b>Up\\Down\\Left\\Right</b> columns</li>
                				</ul>	
								<h5 class="h5">Left Stick</h5>	
								<ul>
									<li><b>Default:</b> The left stick behaves as it normally does and whatever is set on the <b>Left\\Right\\Up\\Down</b> columns is ignored.
									If however, the <i><b>Right Stick</b></i> is set to <i><b>Swapped</b></i>, the <i><b>Left Stick</b></i> emulates the <i><b>Right Stick</b></i> 
									instead
									<li><b>Keyboard:</b> The left stick emulates four keyboard keys or mouse buttons configured on the <b>Left\\Right\\Up\\Down</b> columns</li>
								</ul>			
								<h5 class="h5">Right Stick</h5>		
								<ul>
									<li><b>Default:</b> The <i><b>Right Stick</b></i> behaves as it normally does</li>
									<li><b>Swapped:</b> The <i><b>Right Stick</b></i> emulates the <i><b>Left Stick</b></i></li>
									<li><b>Mouse:</b> The <i><b>Right Stick</b></i> emulates the mouse</li>		
								</ul>				
								<div style='display:inline-block'><b>Dead Zone:</b> The dead zone of the controller sticks when they\'re configured to emulate DirectInput sticks</div>
								<div style='display:inline-block'><b>Mouse sensitivity:</b> How fast the mouse moves when the Right Stick is configured to emulate the mouse</div>
								<div style='display:inline-block'><b>Alt mouse method:</b> Use an alternative method to emulate the mouse with the right stick</div>
								<div style='display:inline-block'><b>Enable force feedback:</b> Force feedback is the DirectInput terminology for vibration\\rumble and 
									also (already back at 1996) haptic feedback, which encompassed, back in the day, four effects: intertia, dampening, friction, and spring. On
									today's XInput controllers, however, only rumble is emulated</div>
								<div style='display:flex;flex-direction:row-reverse'>
									<button type="button" class="btn btn-danger"
										onclick="this.parentElement.parentElement.style.display = 'none'">
										Close
									</button>
								</div>
						</div>
						<div id="j2kroot">
							<table class="table table-sm table-borderless table-secondary" id="dinput_table_root">
								<thead>
									<tr>
										<th scope="col">Button</th>
										<th scope="col">Mode</th>
										<th scope="col">Key A</th>
										<th scope="col">Key B</th>
										<th scope="col">Alt A</th>
										<th scope="col">Alt B</th>
									</tr>
								</thead>
								<tbody id="dinput_table" data-cfg='${JSON.stringify(cfg)}'>									
								</tbody>
							</table>
							<div style='display:flex;flex-direction:row;'>
								<label style='margin-top:2px;margin-right:26px'>Deadzone</label>
								<div style='display:flex;margin-left:6px;margin-top:4px'>
									<input class='slider' type='range' 	min='10' max='50' value='${deadzone}' step='1' id='dinput.deadzone'
									onchange='
										document.getElementById("dinput.deadzone_label").innerText = this.value + "%"
										let cfg = GetDinputCfg()
										cfg.dz = this.value/100
										cfg.update()
									'>
									<label style='margin-left:6px;margin-top:0px' id='dinput.deadzone_label'>${deadzone}%</label>
								</div>						
							</div>
							<div style='display:flex;flex-direction:row;'>
								<label style='margin-top:2px;'>Mouse Speed</label>
								<div style='display:flex;margin-left:6px;margin-top:4px'>
									<input class='slider' type='range' 	min='10' max='100' value='${speed}' step='1' id='dinput.speed'
									onchange='
										document.getElementById("dinput.speed_label").innerText = this.value/100
										let cfg = GetDinputCfg()
										cfg.spd = this.value/100
										cfg.update()
									'>
									<label style='margin-left:6px;margin-top:0px' id='dinput.speed_label'>${speed / 100}</label>
								</div>						
							</div>							
							
							<div style="display:flex;flex-direction:row;gap:10px;align-items:left">
								<input type="checkbox" class="form-check-input" ${cfg.rs_alt ? "checked" : ""}
									style="margin-top:4px" 
									onchange="
									let cfg    = GetDinputCfg();
									cfg.rs_alt = this.checked;
									cfg.update()">
								<label class="form-check-label">
									Alt mouse method
								</label>									
							</div>
							<div style="display:flex;flex-direction:row;gap:10px;align-items:left">
								<input type="checkbox" class="form-check-input" ${cfg.FF ? "checked" : ""}
									style="margin-top:4px" 
									onchange="
									let cfg = GetDinputCfg();
									cfg.FF  = this.checked;
									cfg.update()">
								<label class="form-check-label">
									Enable force feedback
								</label>									
							</div>
							
							<div style="display:flex;flex-direction:row-reverse;gap:10px">								
								<button id='dinput_apply' class="button btn btn-primary" style="width:140px">Apply</button>
								<button id='dinput_help' class="button btn btn-primary" style="width:max-content">
									üí¨ Options explanation
								</button>
							</div>
						</div>`
					)
					for (let [index, button] of ["A", "B", "X", "Y", "Left Bumper", "Right Bumper", "Left Trigger", "Right Trigger", "Back", "Start"
						, "Left Stick - Press", "Right Stick - Press"].entries()) {
						CreateDinputTableRow(button, Key_A, Key_B, Alt_A, Alt_B, index + 4)
					}
					document.getElementById("dinput_table").insertAdjacentHTML("beforeend", /*html*/`
						<tr>
							<th scope="col"></th>
							<th scope="col">Mode</th>
							<th scope="col">Up</th>
							<th scope="col">Down</th>
							<th scope="col">Left</th>
							<th scope="col">Right</th>
						</tr>
					`)
					CeateDpadTableRow(Key_A)
					CeateLStickTableRow(Key_A)
					html = /*html*/`		
					<tr>
						<th scope="row">Right Stick</th>
						<td>
							<select id="dinput.rs" class="form-select" data-self="select" style="width:max-content">
								<option value="0">Default</option>
								<option value="1">Swapped</option>
								<option value="2">Mouse</option>											
							</select>
						</td>
						<td></td><td></td><td></td><td></td>
					</tr>
					`
					document.getElementById("dinput_table").insertAdjacentHTML("beforeend", html)
					document.getElementById("dinput.rs").value = cfg.rs
					document.getElementById("dinput.rs").onchange = () => {
						let cfg = GetDinputCfg()
						cfg.rs = document.getElementById("dinput.rs").value
						cfg.update()
					}
					let modifier_buttons = "A,B,X,Y,Left Button,Right Button,Left Trigger,Right Trigger,Back,Start,Left Stick - Press,Right Stick - Press".split(",")
					html = /*html*/`		
					<tr>
						<th scope="row"><div class="text-bg-danger" 
							style="width:max-content;border-radius:10px;height:40px;padding:8px 16px 16px 16px">Modifier</div>
						</th>
						<td>
							<select id="dinput.modifier" class="form-select" data-self="select" style="width:max-content">
								<option value="0">None</option>
								${modifier_buttons.map((button, index) => `<option value="${index + 5}">${button}</option>`).join("")}													
							</select>
						</td>
						<td></td><td></td><td></td><td></td>
					</tr>
					`
					document.getElementById("dinput_table").insertAdjacentHTML("beforeend", html)
					document.getElementById("dinput.modifier").value = cfg.m
					document.getElementById("dinput.modifier").onchange = () => {
						let cfg = GetDinputCfg()
						cfg.m = document.getElementById("dinput.modifier").value
						cfg.update()
					}

					SetTableThreeState(document.getElementById('j2kroot'), document.getElementById("j2k.u").checked)
					document.getElementById("dinput_apply").onclick = function () {
						let cfg = GetDinputCfg()
						console.log(cfg)
						IniSet(GameName, "u", cfg.u === true ? "true" : "false", "j2k")
						IniSet(GameName, "ff", cfg.FF === true ? "true" : "false", "j2k")
						IniSet(GameName, "rs_alt", cfg.rs_alt === true ? "true" : "false", "j2k")
						IniSet(GameName, "m", cfg.m, "j2k")
						IniSet(GameName, "rs", cfg.rs, "j2k")
						IniSet(GameName, "spd", cfg.spd, "j2k")
						IniSet(GameName, "dz", cfg.dz, "j2k")
						IniSet(GameName, "a", cfg.Key_A.toString(), "j2k")
						IniSet(GameName, "b", cfg.Key_B.toString(), "j2k")
						IniSet(GameName, "x", cfg.Alt_A.toString(), "j2k")
						IniSet(GameName, "y", cfg.Alt_B.toString(), "j2k")
						IniSet(GameName, "mds", cfg.Modes.toString(), "j2k")
						Done("Configuration updated", () => { })
					}
					document.getElementById("dinput_help").onclick = function () {
						document.getElementById("dinput-help-div").style.display = "flex"
					}
					parent.insertAdjacentHTML("beforeend", /*html*/`
						<div class="alert alert-secondary" id=macros-div><h5 class="h5" style="margin-bottom:36px">Macros</h5></div>
					`)
					for (let macro of "s0,s1,s2,s3,s4,s5,r0,r1,t0,t1".split(',')) {
						await AddMacrosRow(macro, document.getElementById("macros-div"), GameName)
					}
				}
			} catch (error) {
				console.log(error)
			}
		}
	}
	async function AddMacrosRow(macro, parent, game) {
		let label = macro.indexOf('s') > -1 ? 'replaces' : macro.indexOf('r') > -1 ? 'repeats &nbsp;' : 'toggles &nbsp;';
		let checked = await IniIsTrue(game, macro + "e", "k2k")
		let trigger = await IniGet(game, macro + "k", "k2k")
		let replaces = await IniGet(game, macro + "v", "k2k")
		let disabned = checked === false ? "disabled" : ""
		checked = checked === true ? "checked" : ""
		console.log(checked, disabned, trigger, replaces)
		if (trigger === "") trigger = "None"
		if (replaces === "") replaces = "None"
		let html = /*html*/`
			<div style="display:flex;flex-direction:row;gap:10px;;margin-top:10px">
				<input type="checkbox" id="${macro}e" class="form-check" ${checked}>
				<button id="${macro}k" class="btn btn-dark" style="width:140px" ${disabned}>${trigger}</button>
				${label}
				<button id="${macro}v" class="btn btn-dark" style="width:140px" ${disabned}>${replaces}</button>
			</div>	
		`
		parent.insertAdjacentHTML("beforeend", html)
		document.getElementById(macro + "e").onchange = () => {
			let checked = document.getElementById(macro + "e").checked
			IniSet(game, macro + "e", checked ? "true" : "false", "k2k")
			document.getElementById(macro + "k").disabled = !checked
			document.getElementById(macro + "v").disabled = !checked
		}
		document.getElementById(macro + "k").onclick = async () => {
			let value = await SelectKey()
			document.getElementById(macro + "k").innerHTML = value === "" ? "None" : value
			IniSet(game, macro + "k", value, "k2k")
		}
		document.getElementById(macro + "v").onclick = async () => {
			let value = await SelectKey()
			document.getElementById(macro + "v").innerHTML = value === "" ? "None" : value
			IniSet(game, macro + "v", value, "k2k")
		}
	}
	function SetTableThreeState(table, state) {
		if (table.tagName.toLowerCase() === "select" || table.tagName.toLowerCase() === "button" || table.tagName.toLowerCase() === "input") {
			table.disabled = state === true ? false : true;
		}
		for (let child of table.children) {
			SetTableThreeState(child, state);
		}
		document.getElementById("dinput_apply").disabled = state === true ? false : true;
	}

	function GetElementsByData(element, elemements) {
		if (element.dataset.self) {
			elemements[element.dataset.self] = element
		}
		for (let child of element.children) {
			GetElementsByData(child, elemements)
		}
	}
	function GetDinputCfg() {
		console.log(document.getElementById("dinput_table").dataset.cfg)
		let cfg = JSON.parse(document.getElementById("dinput_table").dataset.cfg)
		cfg.update = () => {
			document.getElementById("dinput_table").dataset.cfg = JSON.stringify(cfg)
		}
		return cfg
	}
	async function SelectKey() {
		return await (await fetch(`/SelectKey`, FetchOPtions())).text();
	}
	async function SelectXButton() {
		return await (await fetch(`/SelectXButton`, FetchOPtions())).text();
	}
	function CeateDpadTableRow(Key_A) {
		let [up, down, left, right] = [Key_A[0], Key_A[1], Key_A[2], Key_A[3]]
		console.log("======", up, down, left, right)
		if (up === "") up = "None"
		if (down === "") down = "None"
		if (left === "") left = "None"
		if (right === "") right = "None"
		let html = /*html*/`		
			<tr>
				<th scope="row">Dpad</th>
				<td>
					<select class="form-select" data-self="select" style="width:max-content">
						<option value="0">Default</option>
						<option value="3">Keyboard</option>											
					</select>
				</td>
				<td><button data-self="up" class="btn btn-dark" style="width:140px">${up}</button></td>
				<td><button data-self="down" class="btn btn-dark" style="width:140px">${down}</button></td>
				<td><button data-self="left" class="btn btn-dark" style="width:140px">${left}</button></td>
				<td><button data-self="right" class="btn btn-dark" style="width:140px">${right}</button></td>
			</tr>
		`
		document.getElementById("dinput_table").insertAdjacentHTML("beforeend", html)
		let elemements = {}
		GetElementsByData(Array.from(document.getElementById("dinput_table").children).at(-1), elemements)
		console.log(elemements)
		elemements.select.value = GetDinputCfg().Modes[0]
		elemements.select.onchange = () => {
			let cfg = GetDinputCfg()
			cfg.Modes[0] = elemements.select.value
			cfg.Modes[1] = elemements.select.value
			cfg.Modes[2] = elemements.select.value
			cfg.Modes[3] = elemements.select.value
			elemements.up.innerHTML = "None";
			elemements.down.innerHTML = "None";
			elemements.left.innerHTML = "None";
			elemements.right.innerHTML = "None";
			cfg.Key_A[0] = ""
			cfg.Key_A[1] = ""
			cfg.Key_A[2] = ""
			cfg.Key_A[3] = ""
			cfg.update()
		}
		for (let button of ["up", "down", "left", "right"]) {
			elemements[button].onclick = async () => {
				if (elemements.select.value === "0") {
					alert("The dpad is configured at default mode, acting like a Dpad, there is no need to assign keys")
					return
				}
				let key = await SelectKey()
				elemements[button].innerHTML = key === "" ? "None" : key
				let cfg = GetDinputCfg()
				if (button === "up") cfg.Key_A[0] = key
				if (button === "down") cfg.Key_A[1] = key
				if (button === "left") cfg.Key_A[2] = key
				if (button === "right") cfg.Key_A[3] = key
				//console.log(cfg)	
				cfg.update()
			}
		}
	}
	function CeateLStickTableRow(Key_A) {
		let [up, down, left, right] = [Key_A[16], Key_A[17], Key_A[18], Key_A[19]]
		console.log("======", up, down, left, right)
		if (up === "") up = "None"
		if (down === "") down = "None"
		if (left === "") left = "None"
		if (right === "") right = "None"
		let html = /*html*/`		
			<tr>
				<th scope="row">Left Stick</th>
				<td>
					<select class="form-select" data-self="select" style="width:max-content">
						<option value="0">Default</option>
						<option value="3">Keyboard</option>															
					</select>
				</td>
				<td><button data-self="up" class="btn btn-dark" style="width:140px">${up}</button></td>
				<td><button data-self="down" class="btn btn-dark" style="width:140px">${down}</button></td>
				<td><button data-self="left" class="btn btn-dark" style="width:140px">${left}</button></td>
				<td><button data-self="right" class="btn btn-dark" style="width:140px">${right}</button></td>
			</tr>
		`
		document.getElementById("dinput_table").insertAdjacentHTML("beforeend", html)
		let elemements = {}
		GetElementsByData(Array.from(document.getElementById("dinput_table").children).at(-1), elemements)
		console.log(elemements)
		elemements.select.value = GetDinputCfg().Modes[0]
		elemements.select.onchange = () => {
			let cfg = GetDinputCfg()
			cfg.Modes[0] = elemements.select.value
			cfg.Modes[1] = elemements.select.value
			cfg.Modes[2] = elemements.select.value
			cfg.Modes[3] = elemements.select.value
			elemements.up.innerHTML = "None";
			elemements.down.innerHTML = "None";
			elemements.left.innerHTML = "None";
			elemements.right.innerHTML = "None";
			cfg.Key_A[16] = ""
			cfg.Key_A[17] = ""
			cfg.Key_A[18] = ""
			cfg.Key_A[19] = ""
			cfg.update()
		}
		for (let button of ["up", "down", "left", "right"]) {
			elemements[button].onclick = async () => {
				if (elemements.select.value === "0") {
					alert("The left stick is configured at default mode, there is no need to assign keys")
					return
				}
				let key = await SelectKey()
				elemements[button].innerHTML = key === "" ? "None" : key
				let cfg = GetDinputCfg()
				if (button === "up") cfg.Key_A[16] = key
				if (button === "down") cfg.Key_A[17] = key
				if (button === "left") cfg.Key_A[18] = key
				if (button === "right") cfg.Key_A[19] = key
				//console.log(cfg)	
				cfg.update()
			}
		}
	}
	function CreateDinputTableRow(cntr, Key_A, Key_B, Alt_A, Alt_B, i) {
		let [a, b, x, y] = [Key_A[i], Key_B[i], Alt_A[i], Alt_B[i]]
		if (a === "") a = "None"
		if (b === "") b = "None"
		if (x === "") x = "None"
		if (y === "") y = "None"
		let html = /*html*/`
			<tr>
				<th scope="row">${cntr}</th>
				<td>
					<select class="form-select" data-self="select" style="width:max-content">
						<option value="0">Keyboard</option>
						<option value="1">Keyboard Repeat</option>
						<option value="2">Keyboard Toggle</option>
						<option value="4">Keyboard Tap</option>
						<option value="3">DirectInput Gamepad</option>						
					</select>
				</td>
				<td><button data-self="ButtonA" class="btn btn-dark" style="width:140px">${a}</button></td>
				<td><button data-self="ButtonB" class="btn btn-dark" style="width:140px">${b}</button></td>
				<td><button data-self="ButtonX" class="btn btn-dark" style="width:140px">${x}</button></td>
				<td><button data-self="ButtonY" class="btn btn-dark" style="width:140px">${y}</button></td>
			</tr>
		`
		document.getElementById("dinput_table").insertAdjacentHTML("beforeend", html)
		let elemements = {}
		GetElementsByData(Array.from(document.getElementById("dinput_table").children).at(-1), elemements)
		elemements.select.value = GetDinputCfg().Modes[i]
		elemements.select.onchange = function () {
			let cfg = GetDinputCfg()
			cfg.Modes[i] = this.value
			elemements.ButtonA.innerHTML = "None";
			elemements.ButtonB.innerHTML = "None";
			elemements.ButtonX.innerHTML = "None";
			elemements.ButtonY.innerHTML = "None";
			cfg.Key_A[i] = ""
			cfg.Key_B[i] = ""
			cfg.Alt_A[i] = ""
			cfg.Alt_B[i] = ""
			//console.log(cfg)	
			cfg.update()
		}
		for (let button of ["ButtonA", "ButtonB", "ButtonX", "ButtonY"]) {
			elemements[button].onclick = async function () {
				let key = ""
				if (elemements.select.value === "3") key = await SelectXButton()
				else key = await SelectKey()

				elemements[button].innerHTML = key === "" ? "None" : key
				let cfg = GetDinputCfg()
				if (button === "ButtonA") cfg.Key_A[i] = key
				if (button === "ButtonB") cfg.Key_B[i] = key
				if (button === "ButtonX") cfg.Alt_A[i] = key
				if (button === "ButtonY") cfg.Alt_B[i] = key
				//console.log(cfg)	
				cfg.update()
			}
		}
	}
	async function ShowTextSwapDialog(GameName, addbackbutton = false) {
		let mydocs = String.raw`%ProfilesPath%\\`.replace("\\\\", "\\");
		let enabled = await IniIsTrue(GameName, "e", "textswap")
		let autodump = await IniIsTrue(GameName, "a", "textswap")
		let delay = await IniIsTrue(GameName, "dly", "textswap")
		let a8fix = await IniIsTrue(GameName, "a8fix", "textswap")
		let dynamic_tx = await IniIsTrue(GameName, "l", "textswap")
		let toggle = await IniGet(GameName, "sw", "textswap")
		let next = await IniGet(GameName, "n", "textswap")
		let prev = await IniGet(GameName, "p", "textswap")
		let dump = await IniGet(GameName, "d", "textswap")
		let quick = await IniGet(GameName, "q", "textswap")
		let tumb_sz = await IniGet(GameName, "sz", "textswap")
		let sample_count = await IniGet(GameName, "s", "textswap")
		let path = await IniGet(GameName, "path", "textswap")
		console.log(enabled, autodump, delay, a8fix, toggle, next, prev, dump, quick, tumb_sz, sample_count, path)
		prev = prev === "" ? "None" : prev
		next = next === "" ? "None" : next
		dump = dump === "" ? "None" : dump
		quick = quick === "" ? "None" : quick
		toggle = toggle === "" ? "None" : toggle

		let backtopx = /*html*/`
		<button class="btn btn-outline-secondary" style="width:250px;margin-left:10px" data-self="backtopx">
			<i class="fa-solid fa-arrow-up-right-from-square"></i> Back to Pixel Shader Swap
		</button>`
		if (addbackbutton === false) {
			backtopx = ""
		}

		let alpha_textures_popover = (await ParseText(/*html*/`This fixes a bug related to alpha only textures on Blade of darkness and maybe other games,
The correct rendering of fonts on Blade of darkness depends on alpha 
textures returning 1.0 for the color channels when sampled on the pixel stage. 
With the introduction of the programable pipeline, the default value of 
the color channels in alpha only textures on the pixel shader was changed to 
<a href='https://docs.microsoft.com/en-us/windows/win32/direct3dhlsl/texld---ps-2-0' target='_blank'>0.0</a>.
On windows vista - and latter, the  Direct3D runtimes implement the fixed 
function pipeline with 
<a href='https://docs.microsoft.com/en-us/windows-hardware/drivers/display/converting-the-direct3d-fixed-function-state' target='_blank'>shaders</a>. 
What  
I guess happened was that, at that point, the MS programers did not correctly
replicated the fixed function alpha textures behavior on the pixel shaders 
emulating the fixed function pipeline.   
This fix is applied by replacing alpha only textures with full RGBA textures 
with the color channels set to 255`)).replaceAll("\"", "'")

		console.log(alpha_textures_popover)

		let elements = bff(/*html*/`
		<div class="dialog-container" data-self="container">
			<div class="dialog text-bg-light" style="width:1240px;height:900px;padding: 20px;">
				<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px">
					<h6 class="h6" style="text-align:justify; margin-bottom:0">Texture swapping allows replacement of a game's textures with no restrictions on size and format and whithout modifing 
						the game's files. <br>
						Bellow are the texture swapping options (individual, per game), which also seve as a simple tutorial on how to use it 
					</h6>
					<button type="button" class="btn-close" aria-label="Close" data-self="close" style="padding: 5px; margin-left: 10px;"></button>
				</div>
				<div style="display:flex;flex-direction:row; gap:4px">
					<div class="form-check form-switch" style="margin-top:8px">
						<input class="form-check-input" type="checkbox" data-self="enabled">
						<label class="form-check-label">Enabled</label>
					</div>
					${backtopx}
				</div>
				<h6 class="h6" style="text-align:justify;margin-top:0px;margin-bottom:4px">
					To replace textures in a game, you'll start by dumpinfg the textures to disk
				</h6>
				<div style="display:flex;flex-direction:row; gap:4px">
					<div style="display:flex;flex-direction:column; gap:5px">						
						<button class="btn btn-dark" style="width:200px;height:50px" data-self="sw">${toggle}</button>
						<button class="btn btn-dark" style="width:200px;height:50px" data-self="n">${next}</button>
						<button class="btn btn-dark" style="width:200px;height:50px" data-self="p">${prev}</button>
						<button class="btn btn-dark" style="width:200px;height:50px" data-self="q">${quick}</button>
						<button class="btn btn-dark" style="width:200px;height:50px" data-self="d">${dump}</button>
					</div>
					<div style="display:flex;flex-direction:column;width:calc(100% - 20px);gap:5px;font-size:14px">
						<div style="border-radius:6px;border:1px solid #000066;padding:10px;width:100%;height:50px;padding-top:4px;">
							<b>Browse textures:</b> while playing, hit this key to browse textures. After pressing this key, you should immediately see a thumbnail of one of the  
                            game's currently loaded textures, in the top left corner of the screen
						</div>
						<div style="border-radius:6px;border:1px solid #000066;padding:10px;width:100%;height:50px;padding-top:4px;">
							<b>Next</b>: Press this key to select the next texture. 
							You'll notice the texture shown in the top left corner of the screen will change. The current selected texure is also replaced in game by a 
							white and green checkboard patern
						</div>
						<div style="border-radius:6px;border:1px solid #000066;padding:10px;width:100%;height:50px;padding-top:4px;">
							<b>Prev</b>: Press this key to select the previous texture. 
							You'll notice the texture shown in the top left corner of the screen will change. The current selected texure is also replaced in game by a 
							white and green checkboard patern
						</div>
						<div style="border-radius:6px;border:1px solid #000066;padding:10px;width:100%;height:50px;padding-top:4px;">
							<b>Quick</b>: Browse textures more quickly. Holdind the next or prev keys quickly scrolls through the textures
						</div>
						<div style="border-radius:6px;border:1px solid #000066;padding:10px;width:100%;height:50px;padding-top:4px;">
							<b>Dump</b>: Dump the currently selected texture to disk
						</div>
					</div>					
				</div>
				<div style="display:flex;flex-direction:row;gap:50px">
					<div style="display:flex;flex-direction:column;gap:5px;with:70%" class="alert alert-secondary">
						<h6 class="h6" style="text-align:justify;margin-bottom:2px"><b>Path:</b> The path where the textures are dumped</h6>
						<div style="display:flex;flex-direction:row"> 
							<input type="radio" name="tswap_path" value="textures\\voksi">
							<a href="javascript:dummy()" id="${mydocs}textures\\voksi" onclick="PostActionB(this)"
								style="margin-left:4px;margin-top:-4px">${mydocs}textures\\Voksi
							</a>
						</div>	
						<div style="display:flex;flex-direction:row;margin-top:-6px">
							<input type="radio" name="tswap_path" value="textures\\empress">
							<a href="javascript:dummy()" id="${mydocs}textures\\empress" onclick="PostActionB(this)"
								style="margin-left:4px;margin-top:-4px">${mydocs}textures\\Empress
							</a>
						</div>
						<div style="display:flex;flex-direction:row;margin-top:-6px">	
							<input type="radio" name="tswap_path" value="textures\\cpy">
							<a href="javascript:dummy()" id="${mydocs}textures\\cpy" onclick="PostActionB(this)"
								style="margin-left:4px;margin-top:-4px">${mydocs}textures\\CPY
							</a>
						</div>
						<div style="display:flex;flex-direction:row;margin-top:-6px">
							<input type="radio" name="tswap_path" value="textures\\skidrow">
							<a href="javascript:dummy()" id="${mydocs}textures\\skidrow" onclick="PostActionB(this)"
								style="margin-left:4px;margin-top:-4px">${mydocs}textures\\Skidrow
							</a>
						</div>
						<div style="display:flex;flex-direction:row;margin-top:-6px">
							<input type="radio" name="tswap_path" value="textures\\reloaded">
							<a href="javascript:dummy()" id="${mydocs}textures\\reloaded" onclick="PostActionB(this)"
								style="margin-left:4px;margin-top:-4px">${mydocs}textures\\Reloaded
							</a>
						</div>
						<div style="display:flex;flex-direction:row;margin-top:-6px">
							<input type="radio" name="tswap_path" value="textures\\codex">
							<a href="javascript:dummy()" id="${mydocs}textures\\codex" onclick="PostActionB(this)"
								style="margin-left:4px;margin-top:-4px">${mydocs}textures\\CODEX
							</a>
						</div>
						<div style="display:flex;flex-direction:row;margin-top:-6px">
							<input type="radio" name="tswap_path" value="textures\\fitgirl">
							<a href="javascript:dummy()" id="${mydocs}textures\\fitgirl" onclick="PostActionB(this)"
								style="margin-left:4px;margin-top:-4px">${mydocs}textures\\Fitgirl
							</a>
						</div>
						<div style="display:flex;flex-direction:row;margin-top:-6px">
					</div>
				</div>	
				<div style="display:flex;flex-direction:column;gap:5px;with:70%">
					<div style="display:flex;flex-direction:row;gap:10px"
						data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" 
						data-bs-title="Number of lines sampled to <i>'hash'</i> the texture. A smaller count results in smaller dumps, but may also
						cause replacements meant for a particular texture to end up replacing another one.">
						<b>Sample count:</b>
						<input type="range" min="2" max="16" value="${sample_count}" step="2" class="slider" data-self="sample_count" style="margin-left:12px">
						<label data-self="sample_count-label">${sample_count}</label>
					</div>
					<div style="display:flex;flex-direction:row;gap:10px"
						data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" 
						data-bs-title="Size of the thumbnail shown in the top left corner of the screen">
						<b>Thumbnail size:</b>
						<input type="range" min="64" max="512" step="64" value="${tumb_sz}" class="slider" data-self="thumb_size">
						<label data-self="thumb_size-label">${tumb_sz}</label>
					</div>
					<div style="height:10px"></div>
					<div class="form-check form-switch" style="position:relative;width:max-content">
						<input class="form-check-input" type="checkbox" data-self="a8fix">
						<label class="form-check-label" style="width:200px">Alpha textures fix</label>						
						<div style="cursor:pointer;position:absolute;top:-4px;right:-14px"
						data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
						data-bs-content="${alpha_textures_popover}">
							üí¨ 
						</div>	
					</div>
					<div class="form-check form-switch" style="position:relative;width:max-content">
						<input class="form-check-input" type="checkbox" data-self="dly">
						<label class="form-check-label" style="width:200px">Delay Texture Release</label>						
						<div style="cursor:pointer;position:absolute;top:-4px;right:-14px"
						data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
						data-bs-content="Valid for Direct3D <b><i>1</i></b> Games. Fixes crashes on die by the sword and outlaws">
							üí¨ 
						</div>	
					</div>
					<div class="form-check form-switch" style="position:relative;width:max-content">
						<input class="form-check-input" type="checkbox" data-self="autodump">
						<label class="form-check-label" style="width:200px">Auto dump textures</label>
						<div style="cursor:pointer;position:absolute;top:-4px;right:-14px"
						data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
						data-bs-content="Automatically dump textures to while you play - wip üöß">
							üí¨ 
						</div>	
					</div>					
					<div class="form-check form-switch" style="position:relative;width:max-content">
						<input class="form-check-input" type="checkbox" data-self="dynamic_tx">
						<label class="form-check-label" style="width:200px">Dynamic textures - D3D9</label>
						<div style="cursor:pointer;position:absolute;top:-4px;right:-14px"
						data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
						data-bs-content="On Direct3D 9, some textures can only be dumped if they're loaded after you enable the search. 
						This option circumvents this requirement, but incurs a performance penalty.">
							üí¨ 
						</div>	
					</div>
				</div>					
			</div>
			<div class="alert alert-secondary shadow" style="flex-grow:1;margin-top:-20px;margin-bottom:0px;overflow-y:scroll">
				&#11166; REPLACING THE TEXTURE<br>
				<div style='margin-left:40px;margin-bottom:10px'>To finally replace a texture, all you have to do is to place a replacement image with the right
				format and name in the right location<br>
				Say the path option was configured as: <br> <b>${mydocs}VOKSI\\SomeGame</b>, textures will de dumped to:<br>
				<b> ${mydocs}VOKSI\\SomeGame\\Dumps</b> and the replacement should be placed in:<br>
				<b> ${mydocs}VOKSI\\SomeGame\\Replacements</b><br>
				The replacement file must have the same name as the dump, but is installed on the replacements folder</div>
				&#11166; REPLACEMENT FILE PIXEL FORMAT<br>
				<ul>
				<li> Replacement textures must also be in the .dds file format. The recommended pixel format for all games is DXT5, but remember that textures in compressed DXTn formats must have
				sizes that are integer multiples of 4. Even if some programs can create DXTn files with different sizes, those won't be loaded<br>
				<li> To get arround this limitation, or if you want the best possible quality, use the A8R8G8B8 format or - for OpenGl, Direct3D 10 and Direct3D 11 games - A8B8G8R8
				<li> If you want small files, use the DXT1 format, but note that this format doesn't support partial transparency<br>
				<li> On Direct3D 7 and earlier, you will frequently find textures with transparency, but no alpha channel. These textures use 
				<a href='https://en.wikipedia.org/wiki/Chroma_Key' target='_blank'>chroma keying</a>. For these, create replacements
				preferably in the X8R8G8B8 format - R5G6B5 and X1R5G5B5 will also work. The replacement texture will inherit the color key of the original texture. If the replacement texture
				doesn't display transparency correctly, use the same pixel format as the original. This will be fixed in a (not so near) future</ul>
				\
				&#11166; MIPMAPS\
				- Mipmaps are supported in all formats and APIs, but pay attention to the following:<ul>
				<li> On DirectX 7 and earlier, mipmapped textures must have power of two dimensions
				<li> On modern OpenGl games, as in Direct3D 10 and 11, always use mipmapped textures with at least as many levels as the textures they are intended to replace</ul>
				
				&#11166; Distributing textures<br>\
				<div style='margin-left:40px'>If you want to distribute textures you have created, you can <a id=compile  href='javascript:dummy()' onclick='PostActionB(this)'>compile</a> your dumps into a single tinny file: dump._dds. That reduces the size of the files you have to distribute
				and avoid trouble by distributing copyrighted material, asn you can distribute only the dump._dds file no the original dumps. The replacements, obviously, must be distributed.
				After compiling your, the program ignores all .dds files in the dumps folder, therefore, if you dump new textures, run the compiler again or delete the dump._dds file	
			</div>	
		</div>	
		`).PrepentTo(document.body)

		elements.sample_count.onchange = () => {
			elements["sample_count-label"].innerText = elements.sample_count.value
			IniSet(GameName, "s", elements.sample_count.value, "textswap")
		}
		elements.thumb_size.onchange = () => {
			elements["thumb_size-label"].innerText = elements.thumb_size.value
			IniSet(GameName, "sz", elements.thumb_size.value, "textswap")
		}
		elements.container.style.display = "flex"
		elements.enabled.onchange = () => {
			elements.dly.disabled = elements.enabled.checked ? false : "disabled"
			elements.autodump.disabled = elements.enabled.checked ? false : "disabled"
			elements.dynamic_tx.disabled = elements.enabled.checked ? false : "disabled"
			elements.a8fix.disabled = elements.enabled.checked ? false : "disabled"
			elements.sample_count.disabled = elements.enabled.checked ? false : "disabled"
			elements.thumb_size.disabled = elements.enabled.checked ? false : "disabled"
			elements.sw.disabled = elements.enabled.checked ? false : "disabled"
			elements.n.disabled = elements.enabled.checked ? false : "disabled"
			elements.p.disabled = elements.enabled.checked ? false : "disabled"
			elements.q.disabled = elements.enabled.checked ? false : "disabled"
			elements.d.disabled = elements.enabled.checked ? false : "disabled"

			const radios = document.querySelectorAll('input[type="radio"][name="tswap_path"]');
			for (let radio of radios) {
				radio.disabled = elements.enabled.checked ? false : "disabled"
			}
			IniSet(GameName, "e", elements.enabled.checked ? "true" : "false", "textswap")
		}
		elements.enabled.checked = enabled
		elements.enabled.onchange()
		elements.close.onclick = () => {
			elements.container.remove()
		}
		for (let el of "sw n p q d".split(" ")) {
			elements[el].onclick = async () => {
				elements[el].innerText = await SelectKey()
				IniSet(GameName, el, elements[el].innerText, "textswap")
			}
		}
		for (let radio of document.querySelectorAll('input[type="radio"][name="tswap_path"]')) {
			if (radio.value.toLowerCase() === path) {
				radio.checked = true
			}
			radio.onchange = () => {
				if (radio.checked) {
					IniSet(GameName, "path", radio.value, "textswap")
				}
			}
		}
		elements.a8fix.checked = a8fix
		elements.autodump.checked = autodump
		elements.dynamic_tx.checked = dynamic_tx
		elements.dly.checked = delay
		elements.a8fix.onchange = () => { IniSet(GameName, "A8Fix", elements.a8fix.checked ? "true" : "false", "textswap") }
		elements.autodump.onchange = () => { IniSet(GameName, "a", elements.autodump.checked ? "true" : "false", "textswap") }
		elements.dynamic_tx.onchange = () => { IniSet(GameName, "l", elements.dynamic_tx.checked ? "true" : "false", "textswap") }
		elements.dly.onchange = () => { IniSet(GameName, "dly", elements.dly.checked ? "true" : "false", "textswap") }
		if (elements.backtopx) {
			elements.backtopx.onclick = () => {
				elements.container.remove()
				ShowPxSwapDialog(GameName)
			}
		}
		activatetooltips()
		const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]')
		console.log(popoverTriggerList)
		const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl))
	}

	async function ShowPxSwapDialog(GameName) {

		let enabled = await IniIsTrue(GameName, "e", "PxSwap");
		let sw = await IniGet(GameName, "sw", "PxSwap");
		let n = await IniGet(GameName, "n", "PxSwap");
		let p = await IniGet(GameName, "p", "PxSwap");
		let q = await IniGet(GameName, "q", "PxSwap");
		let d = await IniGet(GameName, "d", "PxSwap");
		if (sw === "") sw = "None"
		if (n === "") n = "None"
		if (p === "") p = "None"
		if (q === "") q = "None"
		if (d === "") d = "None"

		let elements = bff(/*html*/`
		<div class="dialog-container" data-self="container">
			<div class="dialog text-bg-light" style="width:1240px;height:550px;padding: 20px;">
				<div style="display: flex; justify-content: space-between; flex-direction: row-reverse; margin-bottom: 4px">
					<button type="button" class="btn-close" aria-label="Close" data-self="close" style="padding: 5px; margin-left: 10px;"></button>
				</div>
				<h6 class="h6" style="text-align:justify;margin-left:20px;margin-right:4px;">
					<li>Pixel shader override is very similar to <span style="text-decoration: underline; cursor: pointer; color:blue"
						data-self="textswap">texture swapping</span>, 
						except that when you dump a shader, you'll have two files on the same folder. A binary file and a text file<br>\
					<li style='margin-top:10px'>The text file contains DirectX Shader Asm code. For DirectX 8 and 9, you can modify that file directly and the changes will take effect next time you start the game<br>\
					<li style='margin-top:10px'> For Direct3D 10 and 11 (and optionally 9) you must create an additional .hlsl file (same name as the .bin and .txt files) and the code in that file will replace the one in\
					the .bin\.txt files. Use the respective shader backtopxmodels supported by each API"					
				</h6>	
				<div class="form-check form-switch">
					<input class="form-check-input" type="checkbox" data-self="enabled">
					<label class="form-check-label">Enabled</label>
				</div>
				<div style="display:flex;flex-direction:row; gap:4px">
					<div style="display:flex;flex-direction:column; gap:5px">						
						<button class="btn btn-dark" style="width:200px;height:50px" data-self="sw">${sw}</button>
						<button class="btn btn-dark" style="width:200px;height:50px" data-self="n">${n}</button>
						<button class="btn btn-dark" style="width:200px;height:50px" data-self="p">${p}</button>
						<button class="btn btn-dark" style="width:200px;height:50px" data-self="q">${q}</button>
						<button class="btn btn-dark" style="width:200px;height:50px" data-self="d">${d}</button>
					</div>	
					<div style="display:flex;flex-direction:column;width:calc(100% - 20px);gap:5px;font-size:14px">
						<div style="border-radius:6px;border:1px solid #000066;padding:10px;width:100%;height:50px;padding-top:4px;">
							<b>Browse shaders:</b> while playing, hit this key to browse textures. After pressing this key, you should immediately some text on 
							in the top left corner of the screen, display the current loaded sahders count and the current pixel shader index
						</div>
						<div style="border-radius:6px;border:1px solid #000066;padding:10px;width:100%;height:50px;padding-top:4px;">
							<b>Next</b>: Press this key to select the next pixel shader. 
							The current selected pixel shader is also replaced in game by a simple shader the only outputs the a pixel from the texture bouond on the 1st texture stage
						</div>
						<div style="border-radius:6px;border:1px solid #000066;padding:10px;width:100%;height:50px;padding-top:4px;">
							<b>Prev</b>: Press this key to select the previous pixel shader. 
							The current selected pixel shader is also replaced in game by a simple shader the only outputs the a pixel from the texture bouond on the 1st texture stage
						</div>						
						<div style="border-radius:6px;border:1px solid #000066;padding:10px;width:100%;height:50px;padding-top:4px;">
							<b>Quick</b>: Browse shaders more quickly. Holdind the next or prev keys quickly scrolls through the shaders
						</div>
						<div style="border-radius:6px;border:1px solid #000066;padding:10px;width:100%;height:50px;padding-top:4px;">
							<b>Dump</b>: Dump the currently selected shader to disk
						</div>
					</div>						
				</div>			
			</div>
		</div>`).PrepentTo(document.body)
		elements.container.style.display = "flex"
		elements.close.onclick = () => {
			elements.container.remove()
		}
		elements.enabled.onchange = () => {
			IniSet(GameName, "e", elements.enabled.checked ? "true" : "false", "PxSwap")
			elements.sw.disabled = elements.enabled.checked ? false : "disabled"
			elements.n.disabled = elements.enabled.checked ? false : "disabled"
			elements.p.disabled = elements.enabled.checked ? false : "disabled"
			elements.q.disabled = elements.enabled.checked ? false : "disabled"
			elements.d.disabled = elements.enabled.checked ? false : "disabled"
		}
		elements.enabled.checked = enabled
		elements.enabled.onchange()
		for (let e of ["sw", "n", "p", "q", "d"]) {
			elements[e].onclick = async () => {
				elements[e].innerText = await SelectKey()
				IniSet(GameName, e, elements[e].innerText, "PxSwap")
			}
		}
		elements.textswap.onclick = () => {
			elements.container.remove()
			ShowTextSwapDialog(GameName, true)
		}
	}
</script>