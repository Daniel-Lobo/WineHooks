<script>
	async function IniGet(game, key, section) {
		return (await (await fetch('/GetVal?Game=' + game + '&Key=' + key + '&Section=' + section, FetchOPtions())).text()).toLowerCase();
	}

	async function IniGetJ2k(game, key, section) {
		let val = (await IniGet(game, key, section)).replaceAll("gamepad", "Gamepad").split(",")
		while (val.length < 20) {
			val.push("")
		}
		return val
	}

	function IniSet(game, key, val, section) {
		fetch('/SetVal?Game=' + game + '&Key=' + key + '&Val=' + val + '&Section=' + section, FetchOPtions());
	}

	async function IniIsTrue(game, key, section) {
		reply = await (await fetch('/IsTrue?Game=' + game + '&Key=' + key + '&Section=' + section, FetchOPtions())).text();
		return reply === 'true' ? true : false;
	}

	async function LaunchCE(game) {
		fetch('/LaunchCE?IniFileName=' + game, FetchOPtions());
	}

	async function ParseText(text) {
		let options = FetchOPtions();
		options.body = text;
		reply = await (await fetch('/ParseText', options)).text();
		//console.log(text, reply)
		return reply;
	}

	function SetResLimitWidgetLabel(_id, game) {
		let [key, section] = _id.includes(".") ? _id.split(".") : [_id, ''];
		IniSet(game, key, document.getElementById(_id).value, section);
		let slider = document.getElementById(_id);
		let label = document.getElementById(_id + "_label");
		label.innerHTML = ["No limit", "640x480", "800x600", "1024x768", "960x540", "1280x720", "1366x768", "1600x900"
			, "1920x1080", "2560x1440", "3840x2160"][slider.value];
	}

	function SetFloatSliderLabelValue(_id, game) {
		let [key, section] = _id.includes(".") ? _id.split(".") : [_id, ''];
		IniSet(game, key, document.getElementById(_id).value, section);
		let slider = document.getElementById(_id);
		let label = document.getElementById(_id + "_label");
		label.innerHTML = slider.value;
	}

	async function AppendLink(link) {
		try {
			let lnk = link.split("->");
			console.log(lnk);
			fetch('/AppendLink?Name=' + lnk[0] + '&Url=' + lnk[1], FetchOPtions());
		} catch (error) {
			console.log(error);
		}
	}

	function GetDisabled(parent, radio_name) {
		if (parent === null) return false;
		if (false === parent.hasAttribute("id")) return false;
		if (false === parent.id.endsWith("_details")) return false;
		let input = document.getElementById(parent.id.replace("_details", ""));
		if (input === null) return false;
		//console.log(input.tagName.toLowerCase(), input.id);
		if (input.tagName.toLowerCase() === "label" && input.hasAttribute("id")) {
			try {
				let value = document.querySelector(`input[name="${input.id}"]:checked`).value;
				console.log(input.id, "=", value);
				return value === '0' ? true : false;
			} catch (error) {
				return false;
			}
		}
		if (false === input.tagName.toLowerCase() == "input" ||
			false === input.hasAttribute("type")) return false;
		if (input.type.toLowerCase() === "checkbox") return input.checked ? false : true;
	}

	function SelectTab(tab) {
		for (let child of document.getElementById("tabs-divs").children) {
			child.style.display = "none";
			child.classList = "tab-pane fade";
		}
		document.getElementById(tab.id.replace("-tab", "_div")).classList = "tab-pane fade show active";
		document.getElementById(tab.id.replace("-tab", "_div")).style.display = "flex";
	}

	function SetThreeState(element, state, game) {
		if (element.tagName.toLowerCase() === "input" && element.hasAttribute("type")) {
			//element.disabled = state === true ? false : true;
			if (element.type.toLowerCase() === "checkbox") {
				let parent = document.getElementById(element.dataset.parent);
				if (parent != null) {
					element.disabled = GetDisabled(parent);
					if (element.disabled === true) {
						element.checked = false;
						let [key, section] = element.id.includes(".") ? element.id.split(".") : [element.id, ''];
						IniSet(game, key, element.checked ? "true" : "false", section);
					}
				}
			}
			else if (element.type.toLowerCase() === "radio") {
				let parent = document.getElementById(element.dataset.parent);
				//console.log(parent.id);
				if (parent != null) {
					element.disabled = GetDisabled(parent, element.name);
					//console.log(element.disabled, element.value);
					if (element.disabled === true) {
						element.checked = element.value === '0' ? true : false;
						if (element.value === '0') {
							let [key, section] = element.name.includes(".") ? element.name.split(".") : [element.name, ''];
							IniSet(game, key, element.value, section);
						}
					}
				}
			}
		}
		for (let child of element.children) {
			SetThreeState(child, state);
		}
	}

	function CheckboxChanged(game, _this) {
		let children_container = document.getElementById(_this.id + "_details");
		SetThreeState(children_container, _this.checked, game);
		let [key, section] = _this.id.includes(".") ? _this.id.split(".") : [_this.id, ''];
		console.log(key, section, _this.checked);
		IniSet(game, key, _this.checked ? "true" : "false", section);
	}

	function RadioChanged(game, _this) {
		let children_container = document.getElementById(_this.name + "_details");
		let state = _this.value === '0' ? true : false
		SetThreeState(children_container, _this.checked);
		let [key, section] = _this.name.includes(".") ? _this.name.split(".") : [_this.name, ''];
		IniSet(game, key, _this.value, section);
	}

	async function RenderGamePage(_this) {
		let GameName = _this.innerText;
		document.getElementById("game-page").innerHTML = /*html*/ `
		<p class="h5" style="margin-top:10px">${GameName}</p>
		<div class="cntrl_group" style="gap:10px;overflow-y:hidden">			
			<div class="cntrl_group" style="gap:0px;overflow-y:auto;min-height:480px;padding-left:10px">
		</div>
		`
		let parent = document.getElementById("game-page").children[1].children[0];
		let help = await (await fetch('/GameHelp?Game=' + GameName, FetchOPtions())).text();
		tokens = help.split("::");
		console.log(help);

		for (let [i, token] of tokens.entries()) {
			try {
				let sec = token.toLowerCase().trim();
				if (sec === 'title') {
					let title = tokens.at(i + 1)
					title = title.toLowerCase().trim() === 'user' ? GameName : title
					let wiki = await IniGet(GameName, 'wiki', '')
					wiki = wiki === '' ? '' : /*html*/` 
					<button class="button btn btn-light" style="width:150px;border:1px solid #000066" onclick="window.open('${wiki}', '_blank')"> 
						<img style="fill:white" src="PCGamingWiki_wide.svg"><img>
					</button> `
					let table = await GetCheatTablePath(GameName)
					table = table === '' ? '' : /*html*/` 
					<button class="button btn btn-light" style="width:120px;border:1px solid #000066" id="CE::Button"
						onclick="
						document.getElementById('CE::Div').classList = 
						document.getElementById('CE::Div').classList.toString() === 'alert alert-warning grow-vertical' ? 
						'alert alert-warning shrink-vertical' : 'alert alert-warning grow-vertical';
						console.log(document.getElementById('CE::Div').classList.toString())
						if (document.getElementById('CE::Div').classList.toString() === 'alert alert-warning srink-vertical') {
							setTimeout(()=>{
								document.getElementById('CE::Div').style.display = 'none';
							}, 500);
						} else{
							document.getElementById('CE::Div').style.display = 'flex';
						}
						"> 
						<img style="margin-top:-4px;margin-right:10px" src="Cheats_small.png"><img>Cheats
					</button>`
					let cediv = table === '' ? '' : /*html*/`
					<div id="CE::Div" class="alert alert-warning shrink-vertical" style="z-index:1;display:none;flex-direction:column;">
						<p class="h3"><b>Using cheats</b><p>
						<ul> 
							<li>Install <a id="cheat" onclick="PostActionB(this)" href="javascript:dummy()">cheat engine (64bit)</a> if you don\'t already have it
							<li> Start <a id="cheat" onclick="PostActionB(this)" href="javascript:dummy()">cheat engine (64bit)</a> using the button bellow and the appropriate table will beloaded
							<li> If you have already stated the game once with WineHooks, cheat engine will attatch itself to the game, and close itself when you exit the game                                                                                                                 	
							<li> Configure cheat engine to aways exectute lua scripts:<br>                                                                                         
							edit &#x2192 settings &#x2192 general settings &#x2192 when a table has a lua script, execute it &#x2192 <b>ALWAYS</b>                                	
							<li> All tables use an Autohotkey plugin, so if you modify or start them directly with cheat engine, they might not work properly                      
							<li> If a cheat doesn\'t work because you have a different version of the game, click table extras on cheat engine                               
							exception made for very old games, I leave comments there which sould help you adapt the table
						</ul>                                                    
						<div style="display:flex;flex-direction:row-reverse;gap:10px">
							<button class="btn btn-light" style="border: 1px solid #000066" onclick="LaunchCE('${GameName.replaceAll('\'', '%27')}')">
								<img style="height:30px" src="ce.svg">
							</button>
							<!--<button class="btn btn-danger"
								onclick="document.getElementById('CE::Div').style.display = 'none'">Close
							</button>-->
						</div>
					</div>
					`
					parent.insertAdjacentHTML('beforeend', /*html*/`
					<p class="h1">${title}</p>
					<div style="display:flex;flex-direction:row;gap:10px;margin-top:10px;margin-bottom:20px;position:relative">
						<button class="button btn btn-secondary" style="width:100px">
							<i class="fa-solid fa-circle-play fa-2xl"></i>
							Play
						</button>	
						<button class="button btn btn-secondary" style="width:200px">
							<i class="fa-solid fa-share fa-2xl"></i>
							Create shortcut
						</button>
						${wiki}
						${table}						
					</div>
					${cediv}
					${await ParseText(tokens.at(i + 2))}
				`)
				} else if (sec === 'parent') {
					let new_parent_id = tokens.at(i + 1).toLowerCase().trim()
					if (new_parent_id.startsWith("pxswap") || new_parent_id.startsWith("textswap")) {
						parent = null;
					}
					if (document.getElementById(new_parent_id) === null) {
						continue
					}
					parent = document.getElementById(new_parent_id)
					if (parent === null) {
						console.error(`parent ${tokens.at(i + 1)} not found`)
					}
				} else if (sec === 'tab') {
					let tbs = ('🏠' + '|' + tokens.at(i + 1)).toLowerCase().trim().split("|")
					let tabs = tbs.map(t =>
						t.replace("graphics", "&#128250;")
							.replace("sound", "&#127911;")
							.replace("input", "&#128377;")
							.replace("file system", "&#128193;")
							.replace("cpu", "MISC"))
					let html = /*html*/`<ul class="nav nav-tabs" id="tabs-buttons" style="display:inline" role="tablist">`
					for (const [index, tab] of tabs.entries()) {
						let active = index === 0 ? "active" : ""
						html += /*html*/`
						<li class="nav-item" role="presentation" style="display:inline">
							<button class="nav-link ${active}" id="${tbs[index]}-tab" style="display:inline"
							data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" 
							aria-controls="profile" aria-selected="false" onclick="SelectTab(this)">${tab}</button>
						</li>
						`
					}
					html +=  /*html*/`</ul><div class="tab-content" id="tabs-divs" style="overflow-y:auto;height:100%">`
					for (const [index, tab] of tabs.entries()) {
						let active = index === 0 ? "show active" : ""
						html += /*html*/`
						<div class="tab-pane fade ${active}" id="${tbs[index]}_div" role="tabpanel" 
							style="display:flex;flex-direction:column;overflow-y:auto;padding-left:10px"
							aria-labelledby="${tbs[index]}-tab" tabindex="${index}">
						</div>`
					}
					html +=  /*html*/`</div>`
					document.getElementById("game-page").children[1].insertAdjacentHTML("beforeend", html)
					let home = document.getElementById("game-page").children[1].children[0]
					document.getElementById("game-page").children[1].removeChild(home)
					document.getElementById('🏠_div').insertAdjacentElement("beforeend", home)
				} else if (sec.endsWith("tab") && !(sec === 'inputtab')) {
					let id = sec.replace("tab", "_div")
					console.log(id)
					parent = document.getElementById(id)
					console.log(parent)
				} else if (sec === 'bool') {
					let id = tokens.at(i + 1).toLowerCase().trim()
					if (id.startsWith("pxswap") || id.startsWith("textswap") || id.startsWith("j2k"))
						continue

					let [key, section] = id.includes(".") ? id.split(".") : [id, '']
					let checked = await IniIsTrue(GameName, key, section) ? "checked" : ""
					let label = await ParseText(tokens.at(i + 2))
					let details = await ParseText(tokens.at(i + 3))
					let disabled = GetDisabled(parent) || id == '4k' ? "disabled" : ""
					parent.insertAdjacentHTML("beforeend", /*html*/`
					<div style="display:flex;flex-direction:column;gap:0px">
						<div style="display:flex;flex-direction:row;gap:10px;align-items:left">
							<input type="checkbox" id="${id}" class="form-check-input" ${checked} ${disabled} data-parent="${parent.id}"
							style="margin-top:4px" onchange="CheckboxChanged('${GameName}', this)">
							<label class="form-check-label" for="${tokens.at(i + 1).toLowerCase().trim()}">${label}</label>					
						</div>
						<label class="form-check-label" for="${tokens.at(i + 1).toLowerCase().trim()}"
							style="margin-left:26px">${details}
						</label>
						<div style="margin-left:26px;margin-top:0px; display:flex;flex-direction:column;gap:0px" id="${id}_details"></div>
					</div>`)
				} else if (sec === 'radiohead') {
					let id = tokens.at(i + 1).toLowerCase().trim()
					let label = await ParseText(tokens.at(i + 2))
					let html = /*html*/`
					<div style='display:flex;flex-direction:column;'>
						<label id="${id}" class="form-check-label">${label}</label>                                                         
						<div id="${id}_details" style='margin-left:26px;display:flex;flex-direction:column' data-parent="${parent.id}"></div>
					</div>`;
					console.log('=======================================rhead=====================================', id)
					parent.insertAdjacentHTML("beforeend", html)
				} else if (sec === 'radio') {
					let [name, value] = tokens.at(i + 1).toLowerCase().trim().split("=")
					if (value === 'false') value = '0';
					let [key, section] = name.includes(".") ? name.split(".") : [name, '']
					let curr_value = await IniGet(GameName, key, section)
					if (curr_value === 'false' || curr_value === '') curr_value = '0'
					let checked = curr_value === value ? "checked" : ""
					let parent_id = parent.dataset.parent
					let disabled = GetDisabled(document.getElementById(parent_id)) ? "disabled" : ""
					console.log(name, value, curr_value, checked)
					parent.insertAdjacentHTML("beforeend", /*html*/`
					<div style="display:flex;flex-direction:row;gap:10px;align-items:left;margin-left:-26px">
						<input type="radio" name="${name}" value="${value}" id="${name}=${value}" class="form-check-input" 
						style="margin-top:4px" ${checked} ${disabled} data-parent="${parent_id}" onchange="RadioChanged('${GameName}', this)">
						<label class="form-check-label" for="${name}=${value}">${tokens.at(i + 3)}</label>					
					</div>`)
				} else if (sec === "link") {
					AppendLink(tokens.at(i + 1))
				} else if (sec === "text") {
					parent.insertAdjacentHTML("beforeend", await ParseText(tokens.at(i + 1)))
				} else if (sec === "_rlmt_") {
					let _id = tokens.at(i + 1).toLowerCase().trim()
					let head = tokens.at(i + 2)
					let index = parseInt(await IniGet(GameName, 'rlmt', ''))
					let val = ["No limit", "640x480", "800x600", "1024x768", "960x540", "1280x720", "1366x768", "1600x900"
						, "1920x1080", "2560x1440", "3840x2160"][index];
					let html = /*html*/`
					<label style='margin-left:7px;margin-bottom:0px'>&bull; &ensp;${head}</label>
						<div style='display:flex;flex-direction:row;margin-left:26px;margin-bottom:0px;margin-top:0px'>
							<input class='slider' onchange='SetResLimitWidgetLabel("${_id}", "${GameName}")' 
								type='range' min='0' max='10' step='1' id='${_id}' value='${index}'>
							<label style='margin-left:6px;margin-top:0px' id='${_id}_label'>${val}</label>                     
						</div>
					<div style='margin-left:24px;margin-top:0px'></div>`
					parent.insertAdjacentHTML("beforeend", html)
				} else if (sec === "float") {
					let [min, max, step] = tokens.at(i + 3).split("-")
					let details = await ParseText(tokens.at(i + 4))
					let _id = tokens.at(i + 1).toLowerCase().trim()
					let head = tokens.at(i + 2)
					let value = await IniGet(GameName, _id, '')

					let html = /*html*/`
					<div style='display:flex;flex-direction:column;'>
						<label style='margin-top:2px;'>${head}</label>
						<div style='display:flex;margin-left:20px;margin-top:0px'>
							<input class='slider' 
									onchange='SetFloatSliderLabelValue("${_id}", "${GameName}")' 
									type='range' 
									min='${min}' 
									max='${max}' 
									value='${value}' 
									step='${step}' 
									id='${_id}'>
							<label style='margin-left:6px;margin-top:0px' id='${_id}_label'>${value}</label>
						</div>
						<div style='display:flex;flex-direction:column;margin-top:0px;margin-left:19px' id='${_id}_details'>${details}</div>
					</div>`
					parent.insertAdjacentHTML("beforeend", html)
				} else if (sec === "hidden") {
					let hint_id = tokens.at(i + 1).toLowerCase().trim()
					let label = await ParseText(tokens.at(i + 2))
					let hint = (await ParseText(tokens.at(i + 3))).replaceAll("<br>", "")
					if (parent === null) continue;

					let html = /*html*/`
					<button class="btn btn-primary" 
						data-bs-toggle="collapse" data-bs-target="#${hint_id}_colapse" 
						aria-expanded="false" aria-controls="collapseExample" 				
						style="display:flex;flex-direction:row;margin-left:0px;gap:2px;width:max-content; padding-bottom:0px;padding-top:0px;
						padding-left:4px;padding-right:8px;margin-bottom:2px">
						<div style="width:40px;rotate:180deg;cursor:pointer;margin-left:0px;margin-top:2px">
							💬 
						</div>
						${label}
					</button>
					<div class="collapse" id="${hint_id}_colapse">
						<div class="card card-body">
							${hint}
						</div>
					</div>
					`
					parent.insertAdjacentHTML("beforeend", html)
				} else if (sec === "endofsettings") {
					let id = "hdpi"
					let [key, section] = id.includes(".") ? id.split(".") : [id, '']
					let checked = await IniIsTrue(GameName, key, section) ? "checked" : ""
					let label = "Hight DPI aware"
					let details = ""
					let disabled = GetDisabled(parent) || id == '4k' ? "disabled" : ""
					parent.insertAdjacentHTML("beforeend", /*html*/`
						<div style="display:flex;flex-direction:column;gap:0px">
							<div style="display:flex;flex-direction:row;gap:10px;align-items:left">
								<input type="checkbox" id="${id}" class="form-check-input" ${checked} ${disabled} data-parent="${parent.id}"
								style="margin-top:4px" onchange="CheckboxChanged('${GameName}', this)">
								<label class="form-check-label" for="${tokens.at(i + 1).toLowerCase().trim()}">${label}</label>					
							</div>
							<label class="form-check-label" for="${tokens.at(i + 1).toLowerCase().trim()}"
								style="margin-left:26px">On windows, enables the hight dpi aware shim
							</label>
							<div style="margin-left:26px;margin-top:0px; display:flex;flex-direction:column;gap:0px" id="${id}_details"></div>
						</div>`)

					let curr_value = await IniGet(GameName, 'compatlayer', '')
					console.log(curr_value)

					let html = /*html*/`
					<div style='display:flex;flex-direction:column;margin-top:0px;margin-left:0px'>
						<label style='margin-top:10px;width:max-content;margin-right:10px'>Windows compatibility modes</label>
						<select class="form-select" id="compatlayer" 
							style="width:max-content;margin-top:6px">
							<option value="don't change">Don't Change</option>
							<option value="none">None</option>
							<option value="dwm8and16bitmitigation">DWM8And16BitMitigation</option>
							<option value="layer_win95versionlie">Layer_Win95VersionLie</option>
							<option value="win95">Win95</option>
							<option value="win98">Win98</option>
							<option value="faulttolerantheap">FaultTolerantHeap</option>
							<option value="win2000">Win2000</option>
							<option value="win2000sp2">Win2000Sp2</option>
							<option value="win2000sp3">Win2000Sp3</option>
							<option value="winxp">WinXP</option>
							<option value="winxpsp2">WinXPSp2</option>
							<option value="winxpsp3">WinXPSp3</option>
							<option value="vistasp2">VistaSp2</option>
						</select>
					</div>
					`
					parent.insertAdjacentHTML("beforeend", html)
					$('.dropdown-toggle').dropdown()
					if (curr_value === "#") curr_value = "don\'t change"
					else if (curr_value === '') curr_value = 'none'
					document.getElementById("compatlayer").value = curr_value;
					document.getElementById("compatlayer").onchange = function () {
						let val = this.value;
						if (val === "don't change") val = "#"
						else if (val === "none") val = ""
						IniSet(GameName, 'compatlayer', val, '')
					}
				} else if (sec === "inputtab") {
					let Key_A = await IniGetJ2k(GameName, 'a', 'j2k')
					let Key_B = await IniGetJ2k(GameName, 'b', 'j2k')
					let Alt_A = await IniGetJ2k(GameName, 'x', 'j2k')
					let Alt_B = await IniGetJ2k(GameName, 'y', 'j2k')
					let Modes = await IniGetJ2k(GameName, 'mds', 'j2k')
					let cfg = {
						'Key_A' : Key_A,
						'Key_B' : Key_B,
						'Alt_A' : Alt_A,
						'Alt_B' : Alt_B,
						'Modes' : Modes,
						'm'     : isNaN(parseInt(await IniGet(GameName, "m", "j2k")))? "0" : await IniGet(GameName, "m", "j2k"),
						'rs'    : isNaN(parseInt(await IniGet(GameName, "rs", "j2k")))? "0" : await IniGet(GameName, "rs", "j2k"),
						'spd'   : isNaN(parseFloat(await IniGet(GameName, "spd", "j2k")))? "0.2" : await IniGet(GameName, "spd", "j2k"),
						'dz'    : isNaN(parseFloat(await IniGet(GameName, "dz", "j2k")))? "0.15" : await IniGet(GameName, "dz", "j2k"),
						'rs_alt': await IniIsTrue(GameName, 'rs_alt', 'j2k'),
						'FF'	: await IniIsTrue(GameName, 'FF', 'j2k'),
						'u'		: await IniIsTrue(GameName, 'u', 'j2k')
					}
					console.log(cfg)
					let deadzone = cfg.dz * 100
					let speed    = cfg.spd * 100
					parent 		 = document.getElementById(sec.replace("tab", "_div"))
					let checked  = await IniIsTrue(GameName, 'u', 'j2k') ? "checked" : ""
					parent.insertAdjacentHTML("beforeend", /*html*/`
						<div style="display:flex;flex-direction:column;gap:0px;position:relative">
							<div style="display:flex;flex-direction:row;gap:10px;align-items:left">
								<input type="checkbox" id="j2k.u" class="form-check-input" ${checked}
									style="margin-top:4px" 
									onchange="
									let cfg = GetDinputCfg();
									cfg.u = this.checked;
									cfg.update();
									SetTableThreeState(document.getElementById('j2kroot'),  this.checked)">
								<label class="form-check-label" for="${"dinput.e".toLowerCase().trim()}">
									Enable Xinput to DirectInput translation
								</label>									
							</div>		
							<label style="margin-left:26px;margin-bottom:20px">
								Input from a <a href="javascript:dummy()" id="dinput" onclick="PostActionB(this)">XInput gamepad</a>
								is translated to <a href="javascript:dummy()" id="dinput" onclick="PostActionB(this)">DirectInput</a>,
								keyboard or mouse input		
							</label>
							<div style="display:none;flex-direction:column;gap:4px;position:absolute;z-index:2" id="dinput-help-div"
								class="alert alert-warning" id="dinput-help" style="width:100%;height:max-content;text-align:justify">	
								<h4 class="h4">Buttons</h4>			
								<ul>
									<li><b>DirectInput Gamepad mode:</b> the button emulates the gamepad button configured in the <b>Key A</b> column</li>
									<li><b>Keyboard mode:</b> the button emulates the keyboard keys or mouse buttons configured in the <i><b>Key A</b></i> and
										<i><b>Key B</b></i> (if any) columns or, if the 
										<div class="text-bg-danger" 
											style="width:max-content;border-radius:10px;height:34px;padding:4px 4px 0px 4px;display:inline-block">
											Modifier
										</div> 
									button is pressed, the keys configured in the  
									<i><b>Alt A</b></i> and <i><b>Alt B</b></i> columns</li>
									<li><b>Keyboard repeat:</b> while held down, the button continuously generates input events from the keyboard key or mouse button configured in the  
									<i><b>Key A</b></i> column. Key combinations or alternative keys are not supported in this mode and neither is the mouse wheel 
									<li><b>Keyboard toggle:</b> when the button is pressed, a <i><b>keydown</b></i> event from the
									<i><b>Key A</b></i> key is generated and a when the button is pressed again, a <i><b>keyup</b></i> event will be sent.
									Mouse input is not supported in this mode and neither are key combinations or alternative keys
									<li><b>Keyboard tap:</b> Simnilar to <b>Keyboard</b>, but pressing the button generates a single tap of the correspoding key even if the\
									button is held down<br></li>\
									<li><b>NOTE:</b> there will be some games on which <b>Keyboard</b> behaves as <b>Keyboard repeat</b> and <b>Keyboard tap</b> behaves as <b>Keyboard</b>
								</ul>
								<h4 class="h4">Dpad</h4>		
								<ul>
									<li><b>Default:</b> The dpad behaves as it normally does and whatever is set on the <b>Up\\Down\\Left\\Right</b> columns is ignored</li>
									<li><b>Keyboard:</b> The dpad emulates four keyboard keys or mouse buttons configured on the <b>Up\\Down\\Left\\Right</b> columns</li>
                				</ul>	
								<h4 class="h4">Left Stick</h4>		
								<ul>
									<li><b>Default:</b> The left stick behaves as it normally does and whatever is set on the <b>Left\\Right\\Up\\Down</b> columns is ignored.
									If however, the <i><b>Right Stick</b></i> is set to <i><b>Swapped</b></i>, the <i><b>Left Stick</b></i> emulates the <i><b>Right Stick</b></i> 
									instead
									<li><b>Keyboard:</b> The left stick emulates four keyboard keys or mouse buttons configured on the <b>Left\\Right\\Up\\Down</b> columns</li>
								</ul>			
								<h4 class="h4">Right Stick</h4>		
								<ul>
									<li><b>Default:</b> The <i><b>Right Stick</b></i> behaves as it normally does</li>
									<li><b>Swapped:</b> The <i><b>Right Stick</b></i> emulates the <i><b>Left Stick</b></i></li>
									<li><b>Mouse:</b> The <i><b>Right Stick</b></i> emulates the mouse</li>		
								</ul>				
								<div style='display:inline-block'><b>Dead Zone:</b> The dead zone of the controller sticks when they\'re configured to emulate DirectInput sticks</div>
								<div style='display:inline-block'><b>Mouse sensitivity:</b> How fast the mouse moves when the Right Stick is configured to emulate the mouse</div>
								<div style='display:inline-block'><b>Alt mouse method:</b> Use an alternative method to emulate the mouse with the right stick</div>
								<div style='display:inline-block'><b>Enable force feedback:</b> Force feedback is the DirectInput terminology for vibration\\rumble and 
									also (already back as 1996) haptic feedback, which encompassed, back in the day, four effects: intertia, dampening, friction, and spring. On
									today's XInput controllers, however, only rumble is emulated</div>
								<div style='display:flex;flex-direction:row-reverse'>
									<button type="button" class="btn btn-danger"
										onclick="this.parentElement.parentElement.style.display = 'none'">
										Close
									</button>
							</div>
						</div>
						<div id="j2kroot">
							<table class="table table-sm table-borderless" id="dinput_table_root">
								<thead>
									<tr>
										<th scope="col">Button</th>
										<th scope="col">Mode</th>
										<th scope="col">Key A</th>
										<th scope="col">Key B</th>
										<th scope="col">Alt A</th>
										<th scope="col">Alt B</th>
									</tr>
								</thead>
								<tbody id="dinput_table" data-cfg='${JSON.stringify(cfg)}'>									
								</tbody>
							</table>
							<div style='display:flex;flex-direction:row;'>
								<label style='margin-top:2px;margin-right:26px'>Deadzone</label>
								<div style='display:flex;margin-left:6px;margin-top:4px'>
									<input class='slider' type='range' 	min='10' max='50' value='${deadzone}' step='1' id='dinput.deadzone'
									onchange='
										document.getElementById("dinput.deadzone_label").innerText = this.value + "%"
										let cfg = GetDinputCfg()
										cfg.dz = this.value/100
										cfg.update()
									'>
									<label style='margin-left:6px;margin-top:0px' id='dinput.deadzone_label'>${deadzone}%</label>
								</div>						
							</div>
							<div style='display:flex;flex-direction:row;'>
								<label style='margin-top:2px;'>Mouse Speed</label>
								<div style='display:flex;margin-left:6px;margin-top:4px'>
									<input class='slider' type='range' 	min='10' max='100' value='${speed}' step='1' id='dinput.speed'
									onchange='
										document.getElementById("dinput.speed_label").innerText = this.value/100
										let cfg = GetDinputCfg()
										cfg.spd = this.value/100
										cfg.update()
									'>
									<label style='margin-left:6px;margin-top:0px' id='dinput.speed_label'>${speed/100}</label>
								</div>						
							</div>							
							
							<div style="display:flex;flex-direction:row;gap:10px;align-items:left">
								<input type="checkbox" class="form-check-input" ${cfg.rs_alt ? "checked" : ""}
									style="margin-top:4px" 
									onchange="
									let cfg    = GetDinputCfg();
									cfg.rs_alt = this.checked;
									cfg.update()">
								<label class="form-check-label">
									Alt mouse method
								</label>									
							</div>
							<div style="display:flex;flex-direction:row;gap:10px;align-items:left">
								<input type="checkbox" class="form-check-input" ${cfg.FF ? "checked" : ""}
									style="margin-top:4px" 
									onchange="
									let cfg = GetDinputCfg();
									cfg.FF  = this.checked;
									cfg.update()">
								<label class="form-check-label">
									Enable force feedback
								</label>									
							</div>
							
							<div style="display:flex;flex-direction:row-reverse;gap:10px">								
								<button id='dinput_apply' class="button btn btn-primary" style="width:140px">Apply</button>
								<button id='dinput_help' class="button btn btn-primary" style="width:max-content">
									💬 Options explanation
								</button>
							</div>
						</div>`
					)					
					for (let [index, button] of ["A", "B", "X", "Y", "Left Bumper", "Right Bumper", "Left Trigger", "Right Trigger", "Back", "Start"
						, "Left Stick - Press", "Right Stick - Press"].entries()) {
						CreateDinputTableRow(button, Key_A, Key_B, Alt_A, Alt_B, index + 4)
					}
					document.getElementById("dinput_table").insertAdjacentHTML("beforeend", /*html*/`
						<tr>
							<th scope="col"></th>
							<th scope="col">Mode</th>
							<th scope="col">Up</th>
							<th scope="col">Down</th>
							<th scope="col">Left</th>
							<th scope="col">Right</th>
						</tr>
					`)
					CeateDpadTableRow(Key_A)
					CeateLStickTableRow(Key_A)
					html = /*html*/`		
					<tr>
						<th scope="row">Right Stick</th>
						<td>
							<select id="dinput.rs" class="form-select" data-self="select" style="width:max-content">
								<option value="0">Default</option>
								<option value="1">Swapped</option>
								<option value="2">Mouse</option>											
							</select>
						</td>
						<td></td><td></td><td></td><td></td>
					</tr>
					`	
					document.getElementById("dinput_table").insertAdjacentHTML("beforeend", html)
					document.getElementById("dinput.rs").value = cfg.rs
					document.getElementById("dinput.rs").onchange = () => {
						let cfg = GetDinputCfg()
						cfg.rs = document.getElementById("dinput.rs").value	
						cfg.update()
					}
					let modifier_buttons="A,B,X,Y,Left Button,Right Button,Left Trigger,Right Trigger,Back,Start,Left Stick - Press,Right Stick - Press".split(",")
					html = /*html*/`		
					<tr>
						<th scope="row"><div class="text-bg-danger" 
							style="width:max-content;border-radius:10px;height:40px;padding:8px 16px 16px 16px">Modifier</div>
						</th>
						<td>
							<select id="dinput.modifier" class="form-select" data-self="select" style="width:max-content">
								<option value="0">None</option>
								${modifier_buttons.map((button, index) => `<option value="${index+5}">${button}</option>`).join("")}													
							</select>
						</td>
						<td></td><td></td><td></td><td></td>
					</tr>
					`
					document.getElementById("dinput_table").insertAdjacentHTML("beforeend", html)
					document.getElementById("dinput.modifier").value = cfg.m
					document.getElementById("dinput.modifier").onchange = () => {
						let cfg = GetDinputCfg()
						cfg.m = document.getElementById("dinput.modifier").value	
						cfg.update()
					}							

					SetTableThreeState(document.getElementById('j2kroot'), document.getElementById("j2k.u").checked)
					document.getElementById("dinput_apply").onclick = function () {
						let cfg = GetDinputCfg()
						console.log(cfg)
					}
					document.getElementById("dinput_help").onclick = function () {
						document.getElementById("dinput-help-div").style.display = "flex"
					}
				}
			} catch (error) {
				console.log(error)
			}
		}
	}
	function SetTableThreeState(table, state) {
		if (table.tagName.toLowerCase() === "select" || table.tagName.toLowerCase() === "button" || table.tagName.toLowerCase() === "input") {
			table.disabled = state === true ? false : true;
		}
		for (let child of table.children) {
			SetTableThreeState(child, state);
		}
		document.getElementById("dinput_apply").disabled = state === true ? false : true;
	}

	function GetElementsByData(element, elemements) {
		if (element.dataset.self) {
			elemements[element.dataset.self] = element
		}
		for (let child of element.children) {
			GetElementsByData(child, elemements)
		}
	}
	function GetDinputCfg() {
		console.log(document.getElementById("dinput_table").dataset.cfg)
		let cfg = JSON.parse(document.getElementById("dinput_table").dataset.cfg)
		cfg.update = () => {
			document.getElementById("dinput_table").dataset.cfg = JSON.stringify(cfg)
		}
		return cfg
	}
	async function SelectKey() {
		return await (await fetch(`/SelectKey`, FetchOPtions())).text();
	}
	async function SelectXButton() {
		return await (await fetch(`/SelectXButton`, FetchOPtions())).text();
	}
	function CeateDpadTableRow(Key_A) {		
		let [up, down, left, right] = [Key_A[0], Key_A[1], Key_A[2], Key_A[3]]
		console.log("======",up, down, left, right)
		if (up    === "") up    = "None"
		if (down  === "") down  = "None"
		if (left  === "") left  = "None"
		if (right === "") right = "None"
		let html = /*html*/`		
			<tr>
				<th scope="row">Dpad</th>
				<td>
					<select class="form-select" data-self="select" style="width:max-content">
						<option value="0">Default</option>
						<option value="3">Keyboard</option>											
					</select>
				</td>
				<td><button data-self="up" class="btn btn-dark" style="width:140px">${up}</button></td>
				<td><button data-self="down" class="btn btn-dark" style="width:140px">${down}</button></td>
				<td><button data-self="left" class="btn btn-dark" style="width:140px">${left}</button></td>
				<td><button data-self="right" class="btn btn-dark" style="width:140px">${right}</button></td>
			</tr>
		`
		document.getElementById("dinput_table").insertAdjacentHTML("beforeend", html)
		let elemements = {}
		GetElementsByData(Array.from(document.getElementById("dinput_table").children).at(-1), elemements)
		console.log(elemements)
		elemements.select.value = GetDinputCfg().Modes[0]
		elemements.select.onchange = () => {
			let cfg = GetDinputCfg()
			cfg.Modes[0] = elemements.select.value
			cfg.Modes[1] = elemements.select.value
			cfg.Modes[2] = elemements.select.value
			cfg.Modes[3] = elemements.select.value
			elemements.up.innerHTML    = "None";
			elemements.down.innerHTML  = "None";
			elemements.left.innerHTML  = "None";
			elemements.right.innerHTML = "None";
			cfg.Key_A[0] = ""
			cfg.Key_A[1] = ""
			cfg.Key_A[2] = ""
			cfg.Key_A[3] = ""
			cfg.update()
		}
		for (let button of ["up", "down", "left", "right"]) {
			elemements[button].onclick = async() => {
				if (elemements.select.value === "0") {
					alert("The dpad is configured at default mode, acting like a Dpad, there is no need to assign keys")
					return
				}
				let key = await SelectKey()
				elemements[button].innerHTML = key === "" ? "None" : key
				let cfg = GetDinputCfg()
				if (button === "up")    cfg.Key_A[0] = key
				if (button === "down")  cfg.Key_A[1] = key
				if (button === "left")  cfg.Key_A[2] = key
				if (button === "right") cfg.Key_A[3] = key
				//console.log(cfg)	
				cfg.update()
			}	
		}
	}
	function CeateLStickTableRow(Key_A) {		
		let [up, down, left, right] = [Key_A[16], Key_A[17], Key_A[18], Key_A[19]]
		console.log("======",up, down, left, right)
		if (up    === "") up    = "None"
		if (down  === "") down  = "None"
		if (left  === "") left  = "None"
		if (right === "") right = "None"
		let html = /*html*/`		
			<tr>
				<th scope="row">Left Stick</th>
				<td>
					<select class="form-select" data-self="select" style="width:max-content">
						<option value="0">Default</option>
						<option value="3">Keyboard</option>															
					</select>
				</td>
				<td><button data-self="up" class="btn btn-dark" style="width:140px">${up}</button></td>
				<td><button data-self="down" class="btn btn-dark" style="width:140px">${down}</button></td>
				<td><button data-self="left" class="btn btn-dark" style="width:140px">${left}</button></td>
				<td><button data-self="right" class="btn btn-dark" style="width:140px">${right}</button></td>
			</tr>
		`
		document.getElementById("dinput_table").insertAdjacentHTML("beforeend", html)
		let elemements = {}
		GetElementsByData(Array.from(document.getElementById("dinput_table").children).at(-1), elemements)
		console.log(elemements)
		elemements.select.value = GetDinputCfg().Modes[0]
		elemements.select.onchange = () => {
			let cfg = GetDinputCfg()
			cfg.Modes[0] = elemements.select.value
			cfg.Modes[1] = elemements.select.value
			cfg.Modes[2] = elemements.select.value
			cfg.Modes[3] = elemements.select.value
			elemements.up.innerHTML    = "None";
			elemements.down.innerHTML  = "None";
			elemements.left.innerHTML  = "None";
			elemements.right.innerHTML = "None";
			cfg.Key_A[16] = ""
			cfg.Key_A[17] = ""
			cfg.Key_A[18] = ""
			cfg.Key_A[19] = ""
			cfg.update()
		}
		for (let button of ["up", "down", "left", "right"]) {
			elemements[button].onclick = async() => {
				if (elemements.select.value === "0") {
					alert("The left stick is configured at default mode, there is no need to assign keys")
					return
				}
				let key = await SelectKey()
				elemements[button].innerHTML = key === "" ? "None" : key
				let cfg = GetDinputCfg()
				if (button === "up")    cfg.Key_A[16] = key
				if (button === "down")  cfg.Key_A[17] = key
				if (button === "left")  cfg.Key_A[18] = key
				if (button === "right") cfg.Key_A[19] = key
				//console.log(cfg)	
				cfg.update()
			}	
		}
	}
	function CreateDinputTableRow(cntr, Key_A, Key_B, Alt_A, Alt_B, i) {
		let [a, b, x, y] = [Key_A[i], Key_B[i], Alt_A[i], Alt_B[i]]
		if (a === "") a = "None"
		if (b === "") b = "None"
		if (x === "") x = "None"
		if (y === "") y = "None"
		let html = /*html*/`
			<tr>
				<th scope="row">${cntr}</th>
				<td>
					<select class="form-select" data-self="select" style="width:max-content">
						<option value="0">Keyboard</option>
						<option value="1">Keyboard Repeat</option>
						<option value="2">Keyboard Toggle</option>
						<option value="4">Keyboard Tap</option>
						<option value="3">DirectInput Gamepad</option>						
					</select>
				</td>
				<td><button data-self="ButtonA" class="btn btn-dark" style="width:140px">${a}</button></td>
				<td><button data-self="ButtonB" class="btn btn-dark" style="width:140px">${b}</button></td>
				<td><button data-self="ButtonX" class="btn btn-dark" style="width:140px">${x}</button></td>
				<td><button data-self="ButtonY" class="btn btn-dark" style="width:140px">${y}</button></td>
			</tr>
		`
		document.getElementById("dinput_table").insertAdjacentHTML("beforeend", html)
		let elemements = {}
		GetElementsByData(Array.from(document.getElementById("dinput_table").children).at(-1), elemements)
		elemements.select.value = GetDinputCfg().Modes[i]
		elemements.select.onchange = function () {
			let cfg = GetDinputCfg()
			cfg.Modes[i] = this.value
			elemements.ButtonA.innerHTML = "None";
			elemements.ButtonB.innerHTML = "None";
			elemements.ButtonX.innerHTML = "None";
			elemements.ButtonY.innerHTML = "None";
			cfg.Key_A[i] = ""
			cfg.Key_B[i] = ""
			cfg.Alt_A[i] = ""
			cfg.Alt_B[i] = ""
			//console.log(cfg)	
			cfg.update()
		}
		for (let button of ["ButtonA", "ButtonB", "ButtonX", "ButtonY"]) {
			elemements[button].onclick = async function () {
				let key = ""
				if (elemements.select.value === "3") key = await SelectXButton()
				else key = await SelectKey()

				elemements[button].innerHTML = key === "" ? "None" : key
				let cfg = GetDinputCfg()
				if (button === "ButtonA") cfg.Key_A[i] = key
				if (button === "ButtonB") cfg.Key_B[i] = key
				if (button === "ButtonX") cfg.Alt_A[i] = key
				if (button === "ButtonY") cfg.Alt_B[i] = key
				//console.log(cfg)	
				cfg.update()
			}
		}
	}
</script>