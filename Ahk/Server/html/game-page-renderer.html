<script>
	async function IniGet(game, key, section){
		return (await (await fetch('/GetVal?Game=' + game + '&Key=' + key + '&Section=' + section, FetchOPtions())).text()).toLowerCase();
	}

	function IniSet(game, key, val, section){
		fetch('/SetVal?Game=' + game + '&Key=' + key + '&Val=' + val + '&Section=' + section, FetchOPtions());
	}

	async function IniIsTrue(game, key, section){
		reply = await (await fetch('/IsTrue?Game=' + game + '&Key=' + key + '&Section=' + section, FetchOPtions())).text();
		return reply === 'true' ? true : false;	
	}

	async function LaunchCE(game) {
		fetch('/LaunchCE?IniFileName=' + game, FetchOPtions());
	}

	async function ParseText(text) {
		let options  = FetchOPtions();
		options.body = text;
		reply = await (await fetch('/ParseText', options)).text();
		//console.log(text, reply)
		return reply;
	}
	
	function SetResLimitWidgetLabel(_id, game) {
		let [key, section] = _id.includes(".") ? _id.split(".") : [_id, ''];
		IniSet(game, key, document.getElementById(_id).value, section);
		let slider = document.getElementById(_id);
		let label  = document.getElementById(_id + "_label");
		label.innerHTML = ["No limit", "640x480", "800x600", "1024x768", "960x540", "1280x720", "1366x768", "1600x900"
		,"1920x1080", "2560x1440", "3840x2160"][slider.value];
	}	

	function SetFloatSliderLabelValue(_id, game) {
		let [key, section] = _id.includes(".") ? _id.split(".") : [_id, ''];
		IniSet(game, key, document.getElementById(_id).value, section);
		let slider = document.getElementById(_id);
		let label  = document.getElementById(_id + "_label");
		label.innerHTML = slider.value;
	}

	async function AppendLink(link) {
		try {
			let lnk = link.split("->");
			console.log(lnk);
			fetch('/AppendLink?Name=' + lnk[0] + '&Url=' + lnk[1], FetchOPtions());
		} catch (error) {
			console.log(error);
		}	
	}

	function GetDisabled(parent, radio_name){
		if (parent === null) return false;
		if (false === parent.hasAttribute("id"))      return false;
		if (false === parent.id.endsWith("_details")) return false;
		let input = document.getElementById(parent.id.replace("_details", ""));
		if (input === null) return false;
		//console.log(input.tagName.toLowerCase(), input.id);
		if (input.tagName.toLowerCase() === "label" && input.hasAttribute("id")) {
			try {
				let value = document.querySelector(`input[name="${input.id}"]:checked`).value;
				console.log(input.id, "=", value);
				return value === '0' ? true : false;
			} catch (error) {
				return false;
			}
		}
		if (false === input.tagName.toLowerCase() == "input" ||
			false === input.hasAttribute("type"))     return false;
		if (input.type.toLowerCase() === "checkbox")  return input.checked ? false : true;
	}

	function SelectTab(tab){
		for (let child of document.getElementById("tabs-divs").children) {
			child.classList     = "tab-pane fade";	
			child.style.display = "none";
		}
		document.getElementById(tab.id.replace("-tab", "_div")).classList     = "tab-pane fade show active";
		document.getElementById(tab.id.replace("-tab", "_div")).style.display = "flex";
	}

	function SetThreeState(element, state, game) {
		if (element.tagName.toLowerCase() === "input" && element.hasAttribute("type")) {
			//element.disabled = state === true ? false : true;
			if (element.type.toLowerCase() === "checkbox") {
				let parent = document.getElementById(element.dataset.parent);
				if (parent != null) {
					element.disabled = GetDisabled(parent);
					if (element.disabled === true) {
						element.checked = false;
						let [key, section] = element.id.includes(".") ? element.id.split(".") : [element.id, ''];
						IniSet(game, key, element.checked ? "true" : "false", section);
					}
				}				
			}
			else if (element.type.toLowerCase() === "radio") {
				let parent = document.getElementById(element.dataset.parent);
				//console.log(parent.id);
				if (parent != null) {
					element.disabled = GetDisabled(parent, element.name);
					//console.log(element.disabled, element.value);
					if (element.disabled === true) {
						element.checked = element.value === '0' ? true : false;
						if (element.value === '0') {
							let [key, section] = element.name.includes(".") ? element.name.split(".") : [element.name, ''];
							IniSet(game, key, element.value, section);							
						}
					}
				}
			}
		}
		for (let child of element.children) {
			SetThreeState(child, state);
		}
	}

	function CheckboxChanged(game, _this){
		let children_container = document.getElementById(_this.id + "_details");
		SetThreeState(children_container, _this.checked, game);
		let [key, section] = _this.id.includes(".") ? _this.id.split(".") : [_this.id, ''];
		console.log(key, section, _this.checked);
		IniSet(game, key, _this.checked ? "true" : "false", section);
	}
	
	function RadioChanged(game, _this){
		let children_container = document.getElementById(_this.name + "_details");
		let state              = _this.value === '0' ? true : false
		SetThreeState(children_container, _this.checked);
		let [key, section]     = _this.name.includes(".") ? _this.name.split(".") : [_this.name, ''];
		IniSet(game, key, _this.value, section);
	}

	async function RenderGamePage(_this) {
		let GameName     = _this.innerText;
		document.getElementById("game-page").innerHTML = /*html*/ `
		<p class="h5" style="margin-top:10px">${GameName}</p>
		<div class="cntrl_group" style="gap:10px;overflow-y:hidden">			
			<div class="cntrl_group" style="gap:0px;overflow-y:auto;min-height:480px">
		</div>
		`
		let parent       = document.getElementById("game-page").children[1].children[0];
		let help		 = await (await fetch('/GameHelp?Game=' + GameName, FetchOPtions())).text();
		tokens           = help.split("::");
		console.log(help);

		for (let [i, token] of tokens.entries()) {
			try{
			let sec = token.toLowerCase().trim();
			if (sec === 'title') {
				let title = tokens.at(i + 1)
				title     = title.toLowerCase().trim() === 'user' ? GameName : title
				let wiki  = await IniGet(GameName, 'wiki', '')
				wiki      = wiki === '' ? '' : /*html*/` 
				<button class="button btn btn-light" style="width:150px;border:1px solid #000066" onclick="window.open('${wiki}', '_blank')"> 
					<img style="fill:white" src="PCGamingWiki_wide.svg"><img>
				</button> ` 
				let table = await GetCheatTablePath(GameName)
				table     = table === '' ? '' : /*html*/` 
				<button class="button btn btn-light" style="width:120px;border:1px solid #000066"
					onclick="document.getElementById('CE::Div').style.display = 'flex'"> 
					<img style="margin-top:-4px;margin-right:10px" src="Cheats_small.png"><img>Cheats
				</button>`
				let cediv = table === '' ? '' : /*html*/`
				<div id="CE::Div" class="alert alert-warning" style="z-index:1;position:absolute;display:none;flex-direction:column;top:60px">
					<p class="h3"><b>Using cheats</b><p>
					<ul> 
						<li>Install <a id="cheat" onclick="PostActionB(this)" href="javascript:dummy()">cheat engine (64bit)</a> if you don\'t already have it
						<li> Start <a id="cheat" onclick="PostActionB(this)" href="javascript:dummy()">cheat engine (64bit)</a> using the button bellow and the appropriate table will beloaded
						<li> If you have already stated the game once with WineHooks, cheat engine will attatch itself to the game, and close itself when you exit the game                                                                                                                 	
						<li> Configure cheat engine to aways exectute lua scripts:<br>                                                                                         
						edit &#x2192 settings &#x2192 general settings &#x2192 when a table has a lua script, execute it &#x2192 <b>ALWAYS</b>                                	
						<li> All tables use an Autohotkey plugin, so if you modify or start them directly with cheat engine, they might not work properly                      
						<li> If a cheat doesn\'t work because you have a different version of the game, click table extras on cheat engine                               
						exception made for very old games, I leave comments there which sould help you adapt the table
					</ul>                                                    
					<div style="display:flex;flex-direction:row-reverse;gap:10px">
						<button class="btn btn-light" style="border: 1px solid #000066" onclick="LaunchCE('${GameName.replaceAll('\'', '%27')}')">
							<img style="height:30px" src="ce.svg">
						</button>
						<button class="btn btn-danger"
							onclick="document.getElementById('CE::Div').style.display = 'none'">Close
						</button>
					</div>
				</div>
				` 
				parent.insertAdjacentHTML('beforeend', /*html*/`
					<p class="h1">${title}</p>
					<div style="display:flex;flex-direction:row;gap:10px;margin-top:10px;margin-bottom:20px;position:relative">
						<button class="button btn btn-secondary" style="width:100px">
							<i class="fa-solid fa-circle-play fa-2xl"></i>
							Play
						</button>	
						<button class="button btn btn-secondary" style="width:200px">
							<i class="fa-solid fa-share fa-2xl"></i>
							Create shortcut
						</button>
						${wiki}
						${table}
						${cediv}
					</div>
					${await ParseText(tokens.at(i + 2))}
				`)		
			} else if (sec === 'parent') {
				let new_parent_id = tokens.at(i + 1).toLowerCase().trim()
				if (new_parent_id.startsWith("pxswap") || new_parent_id.startsWith("textswap")) {
					parent = null;
				}
				if (document.getElementById(new_parent_id) === null) {
					continue
				}
				parent = document.getElementById(new_parent_id)
				if (parent === null) {
					console.error(`parent ${tokens.at(i + 1)} not found`)
				}
			} else if (sec === 'tab') {
				let tbs  = ('🏠' + '|' + tokens.at(i + 1)).toLowerCase().trim().split("|")
				let tabs = tbs.map(t => 
				t.replace("graphics", "&#128250;")
				.replace("sound", "&#127911;")
				.replace("input", "&#128377;")
				.replace("file system", "&#128193;")
				.replace("cpu", "MISC"))
				let html  = /*html*/`<ul class="nav nav-tabs" id="tabs-buttons" style="display:inline" role="tablist">`
				for (const [index, tab] of tabs.entries()) {
					let active = index === 0 ? "active" : ""
					html += /*html*/`
					<li class="nav-item" role="presentation" style="display:inline">
    					<button class="nav-link ${active}" id="${tbs[index]}-tab" style="display:inline"
						data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" 
						aria-controls="profile" aria-selected="false" onclick="SelectTab(this)">${tab}</button>
  					</li>
					`
				} 
				html +=  /*html*/`</ul><div class="tab-content" id="tabs-divs" style="overflow-y:auto;height:100%">`
				for (const [index, tab] of tabs.entries()) {
					let active = index === 0 ? "show active" : ""
					html += /*html*/`
					<div class="tab-pane fade ${active}" id="${tbs[index]}_div" role="tabpanel" 
						style="display:flex;flex-direction:column;overflow-y:auto"
						aria-labelledby="${tbs[index]}-tab" tabindex="${index}">
					</div>`
				}
				html +=  /*html*/`</div>`
				document.getElementById("game-page").children[1].insertAdjacentHTML("beforeend", html)
				let home = document.getElementById("game-page").children[1].children[0]
				document.getElementById("game-page").children[1].removeChild(home)
				document.getElementById('🏠_div').insertAdjacentElement("beforeend", home)
			} else if (sec.endsWith("tab")) {
				let id = sec.replace("tab", "_div")
				console.log(id)
				parent = document.getElementById(id)
				console.log(parent)
			} else if (sec === 'bool') {
				let id = tokens.at(i + 1).toLowerCase().trim()
				if (id.startsWith("pxswap") || id.startsWith("textswap"))
				continue	
				
				let [key, section] = id.includes(".") ? id.split(".") : [id, '']
				let checked  = await IniIsTrue(GameName, key, section) ? "checked" : ""
				let label    = await ParseText(tokens.at(i + 2))
				let details  = await ParseText(tokens.at(i + 3))
				let disabled = GetDisabled(parent) || id == '4k' ? "disabled" : ""
				parent.insertAdjacentHTML("beforeend", /*html*/`
				<div style="display:flex;flex-direction:column;gap:0px">
					<div style="display:flex;flex-direction:row;gap:10px;align-items:left">
						<input type="checkbox" id="${id}" class="form-check-input" ${checked} ${disabled} data-parent="${parent.id}"
						style="margin-top:4px" onchange="CheckboxChanged('${GameName}', this)">
						<label class="form-check-label" for="${tokens.at(i + 1).toLowerCase().trim()}">${label}</label>					
					</div>
					<label class="form-check-label" for="${tokens.at(i + 1).toLowerCase().trim()}"
						style="margin-left:26px">${details}
					</label>
					<div style="margin-left:26px;margin-top:0px; display:flex;flex-direction:column;gap:0px" id="${id}_details"></div>
				</div>`)
			} else if (sec === 'radiohead') {
				let id     = tokens.at(i + 1).toLowerCase().trim()
				let label  = await ParseText(tokens.at(i + 2))
				let html   = /*html*/`
            	<div style='display:flex;flex-direction:column;'>
                    <label id="${id}" class="form-check-label">${label}</label>                                                         
                	<div id="${id}_details" style='margin-left:26px;display:flex;flex-direction:column' data-parent="${parent.id}"></div>
            	</div>`;
				console.log('=======================================rhead=====================================', id)
				parent.insertAdjacentHTML("beforeend", html)
			} else if (sec === 'radio') {
				let [name, value]  = tokens.at(i + 1).toLowerCase().trim().split("=")			
				if (value === 'false') value = '0';
				let [key, section] = name.includes(".") ? name.split(".") : [name, '']
				let curr_value     = await IniGet(GameName, key, section)
				if (curr_value === 'false' || curr_value === '') curr_value = '0'
				let checked   = curr_value === value ? "checked" : ""
				let parent_id = parent.dataset.parent
				let disabled  = GetDisabled(document.getElementById(parent_id))  ? "disabled" : ""
				console.log(name, value, curr_value, checked)
				parent.insertAdjacentHTML("beforeend", /*html*/`
				<div style="display:flex;flex-direction:row;gap:10px;align-items:left;margin-left:-26px">
					<input type="radio" name="${name}" value="${value}" id="${name}=${value}" class="form-check-input" 
					style="margin-top:4px" ${checked} ${disabled} data-parent="${parent_id}" onchange="RadioChanged('${GameName}', this)">
					<label class="form-check-label" for="${name}=${value}">${tokens.at(i + 3)}</label>					
				</div>`)
			} else if (sec === "link"){
				AppendLink(tokens.at(i + 1))
			} else if (sec === "text") {
				parent.insertAdjacentHTML("beforeend", await ParseText(tokens.at(i + 1)))
			} else if (sec === "_rlmt_") {
				let _id     = tokens.at(i + 1).toLowerCase().trim()
				let head    = tokens.at(i + 2)
				let index   = parseInt(await IniGet(GameName, 'rlmt', ''))
				let val     = ["No limit", "640x480", "800x600", "1024x768", "960x540", "1280x720", "1366x768", "1600x900"
				,"1920x1080", "2560x1440", "3840x2160"][index];           
				let html = /*html*/`
					<label style='margin-left:7px;margin-bottom:0px'>&bull; &ensp;${head}</label>
						<div style='display:flex;flex-direction:row;margin-left:26px;margin-bottom:0px;margin-top:0px'>
							<input class='slider' onchange='SetResLimitWidgetLabel("${_id}", "${GameName}")' 
								type='range' min='0' max='10' step='1' id='${_id}' value='${index}'>
							<label style='margin-left:6px;margin-top:0px' id='${_id}_label'>${val}</label>                     
						</div>
					<div style='margin-left:24px;margin-top:0px'></div>`
				parent.insertAdjacentHTML("beforeend", html)	
			} else if (sec === "float") {
			let [min, max, step]  = tokens.at(i + 3).split("-")
			let details			  = await ParseText(tokens.at(i + 4))
			let _id 			  = tokens.at(i + 1).toLowerCase().trim()
			let head 			  = tokens.at(i + 2)
			let value             = await IniGet(GameName, _id, '')

			let html = /*html*/`
			<div style='display:flex;flex-direction:column;'>
				<label style='margin-top:2px;'>${head}</label>
				<div style='display:flex;margin-left:20px;margin-top:0px'>
				<input class='slider' 
						onchange='SetFloatSliderLabelValue("${_id}", "${GameName}")' 
						type='range' 
						min='${min}' 
						max='${max}' 
						value='${value}' 
						step='${step}' 
						id='${_id}'>
				<label style='margin-left:6px;margin-top:0px' id='${_id}_label'>${value}</label>
				</div>
				<div style='display:flex;flex-direction:column;margin-top:0px;margin-left:19px' id='${_id}_details'>${details}</div>
			</div>`
			parent.insertAdjacentHTML("beforeend", html)
          	} else if (sec === "hidden") {
				let hint_id  = tokens.at(i + 1).toLowerCase().trim()
				let label	 = await ParseText(tokens.at(i + 2))
				let hint	 = (await ParseText(tokens.at(i + 3))).replaceAll("<br>", "")
				if (parent === null) continue;              
								
				let html = /*html*/`
				<button class="btn btn-primary" 
					data-bs-toggle="collapse" data-bs-target="#${hint_id}_colapse" 
					aria-expanded="false" aria-controls="collapseExample" 				
					style="display:flex;flex-direction:row;margin-left:0px;gap:2px;width:max-content; padding-bottom:0px;padding-top:0px;
					padding-left:4px;padding-right:8px;margin-bottom:2px">
					<div style="width:40px;rotate:180deg;cursor:pointer;margin-left:0px;margin-top:2px">
						💬 
					</div>
					${label}
				</button>
				<div class="collapse" id="${hint_id}_colapse">
					<div class="card card-body">
						${hint}
					</div>
				</div>
				`
				parent.insertAdjacentHTML("beforeend", html)
			}
		} catch (error) {
			console.log(error)
		}}
	}
</script>	