;REMOTE SCRIPT START
D3DHOOKS_DATA.LockSurface    := IDirectDrawSurface4.lock
D3DHOOKS_DATA.UnLockSurface4 := IDirectDrawSurface4.Unlock
D3DHOOKS_DATA.LockPrimary    := RegisterCallback("Alt_lock")
D3DHOOKS_DATA.UnLockPrimary  := RegisterCallback("Alt_Unlock")
D3DHOOKS_DATA.Bltprimary     := IDirectDrawSurface4.blt

; Fixes the achivments text on wrace's patch 
InstallHook("AltGetClientRect", p, "User32.dll", "GetClientRect")
g_.s.getclient   := p
InstallHook("_BinkClose", p, "BinkW32.dll", "_BinkClose@4")
g_.s._BinkClose  := p
InstallHook("_BinkOpen", p, "BinkW32.dll", "_BinkOpen@8")
g_.s._BinkOpen  := p

_BinkClose(p1)
{
	g_.s._BinkOpened := 0
	return dllcall(g_.s._BinkClose, uint, p1)
}

_BinkOpen(p1, p2)
{
	g_.s._BinkOpened := 1
	return dllcall(g_.s._BinkOpen, uint, p1, uint, p2)
}

AltGetClientRect(p1, p2)
{
	;logerr("AltGetClientRect")
	if (!g_.s._BinkOpened and p1 = g_.hwin)
	{
		r := struct("UINT x, y, w, h")
		r[] := p2
		r.w := D3DHOOKS_DATA.w
		r.h := D3DHOOKS_DATA.h
		return 1
	}
	return dllcall(g_.s.getclient, uint, p1, uint, p2)
}

AltIDirectDrawSurface_QueryInterface(p1, p2, p3)
{
	r := IDirectDrawSurface4_QueryInterface(p1, p2, p3)		
	return r
}

AltIDirectDraw2_CreateSurface(pIDirectDraw, pSurfaceDesc, ppSurface, pIUnknown)
{
	D    := struct(DDSURFACEDESC)
	D[]  := pSurfaceDesc
	caps := D.ddsCaps.dwCaps
	if (r := IDirectDraw2_CreateSurface(pIDirectDraw, pSurfaceDesc, ppSurface, pIUnknown))
		return r
	if (caps & DDSCAPS_PRIMARYSURFACE)
	{
		g_.proxies.D3D        := new D3DDevice(dllcall(g_.p.DDFrmSrfc, uint, g_.primary), (640<<16)|480)
		g_.proxies.prim       := new Surface(dllcall(g_.p.DDFrmSrfc, uint, g_.primary), "", (g_.desktop.w<<16)|g_.desktop.h)
		g_.proxies.dev        := new Surface(dllcall(g_.p.DDFrmSrfc, uint, g_.primary), "", (640<<16)|480)
		
		g_.proxies_shader := D3DDDI_CreatePixelShader(G_D3DDDI.shader_code, "LineDoubling")
		g_.rect := struct(rect), g_.rect.top := 0, g_.rect.left := 0, g_.rect.right := 640, g_.Rect.bottom := 480
		g_.proxies.prms    := Struct("Float[4]")
		g_.proxies.prms[1] := 1/640
		g_.proxies.prms[2] := 1/480				
		;IDirectDrawSurface2.PatchVtable("lock")
		;IDirectDrawSurface2.PatchVtable("Unlock")	
	}
	return r
}

Alt_lock(p1, p2, p3, p4, p5)
{
	if (GetSurfaceCaps(p1) & DDSCAPS_PRIMARYSURFACE)
	{
		;logerr("Lock primary " isobject(g_.proxies.prim))
		p1 := g_.proxies.prim.Surface
		return dllcall(IDirectDrawSurface4.lock, uint, p1, uint, p2, uint, p3, uint, p4, uint, p5, uint)
	}
	return surface1lock(p1, p2, p3, p4, p5)
}	

Alt_Unlock(p1, p2)
{
	if (GetSurfaceCaps(p1) & DDSCAPS_PRIMARYSURFACE) 
	{
		prim := p1
		p1 := g_.proxies.prim.Surface
		r := dllcall(IDirectDrawSurface.Unlock, uint, p1, uint, p2)
		;return r
		if (p1 = g_.proxies.prim.surface)
		{
			dllcall(IDirectDrawSurface4.blt, uint, g_.proxies.dev.Surface, uint,  g_.rect[]
										   , uint, g_.proxies.prim.surface, uint, g_.rect[]
										   , uint, DDBLT_WAIT, uint, 0, uint)	
										  
			DEVICE3_RECT.Texture := g_.proxies.dev.Texture
			DEVICE3_RECT.Device3 := g_.proxies.D3D.Device3
			D3DDDI_SetShaderOverride(g_.proxies.fmvs)
			dllcall(G_D3DDDI.SetPixelShaderConst, uint, D3DDDI_HOOKS.hDev, "uint64*", 223 | 1<<32, uint, g_.proxies.prms[])
			dllcall(g_.p.Dev3_DrawRect, uint, DEVICE3_RECT[], uint, g_.rect[], float, 0, uint)
			D3DDDI_RestoreShader()
			
			_rect_setscale(g_.cfg.FMV)							 
			dllcall(IDirectDrawSurface4.blt, uint, prim, uint,  _rect[]
										   , uint, g_.proxies.D3D.surface, uint, g_.rect[]
										   , uint, DDBLT_WAIT, uint, 0, uint)	
			_rect_setscale(0)								 
		}
		return r
	}
	return surface4unlock(p1, p2)
}

/*
AltDDrawCreate(p1, p2, p3)
{
	(g_.pIDirectDraw) ? g_.pIDirectDraw := dllcall(IDirectDraw.Release, uint, g_.pIDirectDraw) * 0
	if (r := dllcall(g_.pDirectDrawCreate, uint, p1, uint, p2, uint, p3))
		return r
	g_.pIDirectDraw := numget(p2+0, "ptr")
	dllcall(IDirectDraw.addref, uint, g_.pIDirectDraw)	
	return r
}
*/
